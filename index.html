<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>プロジェクトポータル - ベステラ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* ベステラ コーポレートカラー */
            /* 「壊すことを、美しく」- 洗練されたプロフェッショナルデザイン */

            /* メインカラー - チャコールグレー（信頼・堅実） */
            --primary-color: #2d3a4a;
            --primary-hover: #1e2a38;
            --primary-light: #e8ebef;

            /* アクセントカラー - ブルーグレー（先進性・技術力） */
            --accent-color: #4a7c9b;
            --accent-hover: #3a6a87;
            --accent-light: #e6f0f5;

            /* セカンダリ */
            --secondary-color: #5a6a7a;

            /* ステータスカラー */
            --success-color: #2e7d5a;
            --success-light: #e8f5ef;
            --warning-color: #b8860b;
            --warning-light: #fdf6e3;
            --danger-color: #c0392b;
            --danger-light: #fdeaea;

            /* 背景 - ウォームホワイト */
            --bg-color: #f7f6f4;
            --bg-warm: #faf9f7;
            --card-bg: #ffffff;

            /* テキスト */
            --text-primary: #1a1a1a;
            --text-secondary: #4a5568;
            --text-light: #718096;
            --text-muted: #a0aec0;

            /* ボーダー */
            --border-color: #e2e0dc;
            --border-light: #efeee9;

            /* 管理者カラー - 深みのあるパープル */
            --admin-color: #4a3f6b;
            --admin-hover: #3a3058;

            /* シャドウ - 控えめで上品 */
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.06);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.1);

            /* 角丸 - やや控えめでプロフェッショナル */
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 14px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans JP', 'Hiragino Sans', 'Meiryo', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            line-height: 1.7;
            min-height: 100vh;
            font-size: 15px;
            -webkit-font-smoothing: antialiased;
        }

        /* ログイン画面 - ベステラブランド */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #2d3a4a 0%, #1e2a38 50%, #4a7c9b 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .login-overlay.hidden {
            display: none;
        }

        .login-box {
            background: white;
            padding: 48px 40px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            width: 90%;
            max-width: 420px;
        }

        .login-box h1 {
            text-align: center;
            margin-bottom: 8px;
            color: var(--text-primary);
            font-size: 28px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .login-box .subtitle {
            text-align: center;
            color: var(--text-secondary);
            margin-bottom: 36px;
            font-size: 15px;
        }

        .login-tabs {
            display: flex;
            margin-bottom: 24px;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid var(--border-color);
        }

        .login-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            background: white;
        }

        .login-tab.active {
            background: var(--primary-color);
            color: white;
        }

        .login-tab.admin.active {
            background: var(--admin-color);
        }

        .login-form {
            display: none;
        }

        .login-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 14px;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 16px;
            transition: all 0.2s;
            background: #fff;
        }

        .form-group input:hover, .form-group select:hover, .form-group textarea:hover {
            border-color: var(--text-light);
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 28px;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-admin {
            background: var(--admin-color);
            color: white;
            width: 100%;
        }

        .btn-admin:hover {
            background: var(--admin-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background: #0a6632;
            transform: translateY(-1px);
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background: #a01616;
            transform: translateY(-1px);
        }

        .btn-warning {
            background: var(--warning-color);
            color: white;
        }

        .btn-warning:hover {
            background: #944100;
            transform: translateY(-1px);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--border-color);
            color: var(--text-primary);
        }

        .btn-outline:hover {
            background: var(--bg-color);
            border-color: var(--text-light);
        }

        .btn-sm {
            padding: 10px 16px;
            font-size: 14px;
            font-weight: 600;
        }

        .btn-icon {
            padding: 10px;
            min-width: 40px;
        }

        .error-message {
            color: var(--danger-color);
            font-size: 14px;
            margin-top: 8px;
            display: none;
            background: var(--danger-light);
            padding: 12px;
            border-radius: var(--radius-sm);
        }

        .error-message.show {
            display: block;
        }

        /* ヘッダー - モダンデザイン */
        .header {
            background: white;
            padding: 0 24px;
            height: 64px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header.admin-header {
            background: linear-gradient(135deg, var(--admin-color) 0%, var(--admin-hover) 100%);
            color: white;
            border-bottom: none;
        }

        .header-content {
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 20px;
            font-weight: 800;
            color: var(--primary-color);
            letter-spacing: -0.5px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            text-decoration: none;
            transition: opacity 0.2s;
        }

        .logo:hover {
            opacity: 0.8;
        }

        .logo-img {
            height: 32px;
            width: auto;
        }

        .logo-text {
            display: flex;
            flex-direction: column;
            line-height: 1.2;
        }

        .logo-main {
            font-size: 18px;
            font-weight: 800;
            color: var(--primary-color);
        }

        .logo-sub {
            font-size: 10px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .header.admin-header .logo-main,
        .header.admin-header .logo-sub {
            color: white;
        }

        .logo-icon {
            font-size: 24px;
        }

        .header.admin-header .logo {
            color: white;
        }

        .admin-badge {
            background: rgba(255,255,255,0.2);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 12px;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .user-info {
            display: none;
            flex-direction: column;
            align-items: flex-end;
        }

        .user-name {
            font-weight: 600;
            font-size: 14px;
            color: var(--text-primary);
        }

        .user-dept {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .header.admin-header .user-name,
        .header.admin-header .user-dept {
            color: rgba(255,255,255,0.9);
        }

        @media (min-width: 600px) {
            .user-info {
                display: flex;
            }
        }

        .user-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .user-avatar:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(45, 58, 74, 0.3);
        }

        .header.admin-header .user-avatar {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
        }

        .user-dropdown {
            position: relative;
        }

        .dropdown-menu {
            position: absolute;
            top: 54px;
            right: 0;
            background: white;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            min-width: 220px;
            display: none;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .dropdown-menu.show {
            display: block;
            animation: dropdownFade 0.15s ease;
        }

        @keyframes dropdownFade {
            from {
                opacity: 0;
                transform: translateY(-8px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .dropdown-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-color);
        }

        .dropdown-header-name {
            font-weight: 700;
            color: var(--text-primary);
        }

        .dropdown-header-dept {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .dropdown-item {
            padding: 14px 16px;
            cursor: pointer;
            transition: background 0.15s;
            color: var(--text-primary);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .dropdown-item:hover {
            background: var(--bg-color);
        }

        .dropdown-item.danger {
            color: var(--danger-color);
        }

        .dropdown-item.danger:hover {
            background: var(--danger-light);
        }

        /* メインコンテンツ */
        .main-content {
            max-width: 800px;
            margin: 0 auto;
            padding: 24px;
            padding-bottom: 100px;
        }

        .admin-content {
            max-width: 1100px;
        }

        /* 検索バー - Indeed風の大きなデザイン */
        .search-section {
            background: white;
            padding: 32px 24px;
            border-radius: var(--radius-lg);
            margin-bottom: 24px;
            box-shadow: var(--shadow-md);
        }

        .search-section h2 {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 16px;
            color: var(--text-primary);
        }

        .search-bar {
            margin-bottom: 0;
            position: relative;
        }

        .search-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .search-icon {
            position: absolute;
            left: 20px;
            color: var(--text-light);
            font-size: 20px;
            pointer-events: none;
        }

        .search-input {
            width: 100%;
            padding: 18px 20px 18px 52px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 17px;
            background: #fafafa;
            transition: all 0.2s ease;
        }

        .search-input:hover {
            background: white;
            border-color: var(--text-light);
        }

        .search-input:focus {
            outline: none;
            background: white;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px var(--primary-light);
        }

        .search-input::placeholder {
            color: var(--text-light);
        }

        /* タブ */
        .tabs {
            display: flex;
            background: white;
            border-radius: 12px;
            padding: 6px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .tab {
            flex: 1;
            padding: 12px 16px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .tab.active {
            background: var(--primary-color);
            color: white;
        }

        .tab:not(.active):hover {
            background: var(--bg-color);
        }

        /* 管理者タブ */
        .admin-tabs {
            display: flex;
            background: white;
            border-radius: 12px;
            padding: 6px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            flex-wrap: wrap;
        }

        .admin-tab {
            flex: 1;
            min-width: 120px;
            padding: 12px 16px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .admin-tab.active {
            background: var(--admin-color);
            color: white;
        }

        .admin-tab:not(.active):hover {
            background: var(--bg-color);
        }

        /* プロジェクトカード - Indeed風クリーンデザイン */
        .project-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .project-card {
            background: white;
            border-radius: var(--radius-md);
            overflow: hidden;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .project-card:hover {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 1px var(--primary-color);
        }

        .project-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: transparent;
            transition: background 0.2s;
        }

        .project-card:hover::before {
            background: var(--primary-color);
        }

        .project-image {
            width: 100%;
            height: 120px;
            object-fit: cover;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 40px;
        }

        .project-content {
            padding: 20px 24px;
        }

        .project-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .project-category {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 0.3px;
        }

        .category-company {
            background: var(--accent-light);
            color: var(--accent-color);
        }

        .category-department {
            background: var(--success-light);
            color: var(--success-color);
        }

        .category-other {
            background: var(--warning-light);
            color: var(--warning-color);
        }

        .project-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--text-primary);
            line-height: 1.4;
        }

        .project-card:hover .project-title {
            color: var(--primary-color);
        }

        .project-description {
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 16px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .project-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }

        .project-capacity {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .capacity-bar {
            width: 100px;
            height: 8px;
            background: var(--bg-color);
            border-radius: 4px;
            overflow: hidden;
        }

        .capacity-fill {
            height: 100%;
            background: var(--success-color);
            border-radius: 4px;
            transition: width 0.3s;
        }

        .capacity-fill.warning {
            background: var(--warning-color);
        }

        .capacity-fill.full {
            background: var(--danger-color);
        }

        .project-status {
            padding: 6px 14px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
        }

        .status-recruiting {
            background: var(--success-light);
            color: var(--success-color);
        }

        .status-ongoing {
            background: var(--accent-light);
            color: var(--accent-color);
        }

        .status-closed {
            background: #f1f5f9;
            color: #64748b;
        }

        /* 詳細モーダル - モダンデザイン */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            display: none;
            align-items: flex-end;
            justify-content: center;
            z-index: 200;
        }

        .modal-overlay.show {
            display: flex;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }
            to {
                transform: translateY(0);
            }
        }

        .modal-header {
            position: sticky;
            top: 0;
            background: white;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }

        .modal-header h2 {
            font-size: 20px;
            font-weight: 700;
        }

        .modal-close {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: none;
            background: var(--bg-color);
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: var(--border-color);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 24px;
        }

        .detail-image {
            width: 100%;
            height: 180px;
            object-fit: cover;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover) 100%);
            border-radius: var(--radius-md);
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 56px;
        }

        .detail-section {
            margin-bottom: 24px;
        }

        .detail-section h3 {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-section p {
            color: var(--text-primary);
            line-height: 1.8;
        }

        .member-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .member-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: var(--bg-color);
            border-radius: 20px;
            font-size: 14px;
        }

        .member-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 600;
        }

        .progress-section {
            background: var(--bg-color);
            padding: 16px;
            border-radius: 12px;
        }

        .progress-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .progress-item:last-child {
            border-bottom: none;
        }

        .comment-section {
            background: var(--bg-color);
            padding: 16px;
            border-radius: 12px;
        }

        .comment-item {
            display: flex;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .comment-item:last-child {
            border-bottom: none;
        }

        .comment-content {
            flex: 1;
        }

        .comment-author {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .comment-text {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .comment-date {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* フッターアクション */
        .modal-footer {
            position: sticky;
            bottom: 0;
            background: white;
            padding: 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 12px;
        }

        .modal-footer .btn {
            flex: 1;
        }

        /* 申請完了モーダル */
        .success-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 40px;
            border-radius: 16px;
            text-align: center;
            z-index: 300;
            display: none;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .success-modal.show {
            display: block;
        }

        .success-icon {
            width: 80px;
            height: 80px;
            background: var(--success-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 40px;
            color: white;
        }

        /* 統計セクション - モダンデザイン */
        .stats-section {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: white;
            padding: 24px 20px;
            border-radius: var(--radius-md);
            text-align: center;
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
        }

        .stat-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
        }

        .stat-number {
            font-size: 32px;
            font-weight: 800;
            color: var(--primary-color);
            line-height: 1;
        }

        .stat-label {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 8px;
            font-weight: 500;
        }

        /* マイページ */
        .my-projects {
            margin-top: 20px;
        }

        .my-projects h2 {
            font-size: 18px;
            margin-bottom: 16px;
            color: var(--text-primary);
        }

        .my-project-item {
            display: flex;
            align-items: center;
            gap: 16px;
            background: white;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .my-project-icon {
            width: 50px;
            height: 50px;
            border-radius: var(--radius-md);
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            flex-shrink: 0;
        }

        .my-project-info {
            flex: 1;
        }

        .my-project-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .my-project-role {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .my-project-actions {
            display: flex;
            gap: 8px;
        }

        /* フッターナビ - モダンデザイン */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: white;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
            padding-bottom: calc(8px + env(safe-area-inset-bottom));
            z-index: 50;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            color: var(--text-light);
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 8px 20px;
            border-radius: var(--radius-sm);
            position: relative;
        }

        .nav-item.active {
            color: var(--primary-color);
        }

        .nav-item.active::after {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 32px;
            height: 3px;
            background: var(--primary-color);
            border-radius: 0 0 3px 3px;
        }

        .nav-item:hover {
            color: var(--primary-color);
            background: var(--primary-light);
        }

        .nav-icon {
            font-size: 22px;
            transition: transform 0.2s;
        }

        .nav-item:hover .nav-icon {
            transform: scale(1.1);
        }

        .nav-label {
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.2px;
        }

        /* ページ切り替え */
        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* 通知バッジ */
        .notification-badge {
            position: relative;
        }

        .notification-badge::after {
            content: attr(data-count);
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--danger-color);
            color: white;
            font-size: 10px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 10px;
        }

        /* 管理者画面 */
        .admin-section {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .admin-section h2 {
            font-size: 18px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .admin-table {
            width: 100%;
            border-collapse: collapse;
        }

        .admin-table th,
        .admin-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .admin-table th {
            background: var(--bg-color);
            font-weight: 600;
            font-size: 14px;
        }

        .admin-table tr:hover {
            background: var(--bg-color);
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .application-status, .user-role {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .application-pending {
            background: var(--warning-light);
            color: var(--warning-color);
        }

        .application-approved {
            background: var(--success-light);
            color: var(--success-color);
        }

        .application-rejected {
            background: var(--danger-light);
            color: var(--danger-color);
        }

        .role-admin {
            background: #e8e4f0;
            color: var(--admin-color);
        }

        .role-user {
            background: var(--accent-light);
            color: var(--accent-color);
        }

        .user-status-active {
            background: var(--success-light);
            color: var(--success-color);
        }

        .user-status-inactive {
            background: var(--border-light);
            color: var(--text-light);
        }

        .role-manager {
            background: var(--warning-light);
            color: var(--warning-color);
        }

        /* ワークフローステータス */
        .workflow-draft {
            background: var(--border-light);
            color: var(--text-light);
        }

        .workflow-pending-manager {
            background: var(--warning-light);
            color: var(--warning-color);
        }

        .workflow-pending-admin {
            background: var(--accent-light);
            color: var(--accent-color);
        }

        .workflow-pending-approver {
            background: #f0e6ff;
            color: #6b46c1;
        }

        .workflow-approved {
            background: var(--success-light);
            color: var(--success-color);
        }

        .workflow-rejected {
            background: var(--danger-light);
            color: var(--danger-color);
        }

        /* ワークフロー履歴 */
        .workflow-history {
            background: var(--bg-color);
            border-radius: 12px;
            padding: 16px;
            margin-top: 16px;
        }

        .workflow-history-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .workflow-history-item:last-child {
            border-bottom: none;
        }

        .workflow-history-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }

        .workflow-history-icon.pending {
            background: var(--warning-light);
        }

        .workflow-history-icon.approved {
            background: var(--success-light);
        }

        .workflow-history-icon.rejected {
            background: var(--danger-light);
        }

        .workflow-info-box {
            background: var(--accent-light);
            color: var(--accent-color);
            padding: 14px 16px;
            border-radius: var(--radius-sm);
            margin-bottom: 20px;
            font-size: 14px;
            border-left: 4px solid var(--accent-color);
        }

        /* ワークフロー設定セクション */
        .workflow-settings-section {
            background: var(--bg-warm);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 20px;
            margin-top: 20px;
        }

        .workflow-settings-section .section-label {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
            display: block;
            margin-bottom: 16px;
        }

        .workflow-steps-preview {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 16px;
            background: white;
            border-radius: var(--radius-sm);
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .workflow-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .step-number {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--accent-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
        }

        .step-label {
            font-size: 11px;
            color: var(--text-secondary);
            text-align: center;
            max-width: 70px;
        }

        .workflow-arrow {
            color: var(--text-light);
            font-size: 18px;
            margin: 0 4px;
        }

        .form-hint {
            font-size: 12px;
            color: var(--text-light);
            margin-top: 6px;
        }

        /* 画像設定セクション */
        .image-settings-section {
            background: var(--bg-warm);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 20px;
            margin-bottom: 20px;
        }

        .image-settings-section .section-label {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
            display: block;
            margin-bottom: 8px;
        }

        .image-size-info {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 16px;
            padding: 8px 12px;
            background: white;
            border-radius: var(--radius-sm);
            border: 1px dashed var(--border-color);
        }

        .image-option-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .image-option-tab {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-sm);
            background: white;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-secondary);
        }

        .image-option-tab:hover {
            border-color: var(--accent-color);
            color: var(--accent-color);
        }

        .image-option-tab.active {
            border-color: var(--accent-color);
            background: var(--accent-light);
            color: var(--accent-color);
        }

        .image-option-content {
            background: white;
            border-radius: var(--radius-sm);
            padding: 16px;
            border: 1px solid var(--border-color);
        }

        .image-option-content.hidden {
            display: none;
        }

        .auto-image-settings {
            margin-bottom: 16px;
        }

        .image-preview-container {
            text-align: center;
        }

        .image-preview-container > label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 13px;
        }

        .image-preview {
            background: var(--bg-color);
            border-radius: var(--radius-sm);
            overflow: hidden;
            margin-bottom: 12px;
            border: 1px solid var(--border-color);
        }

        .image-preview canvas {
            width: 100%;
            height: auto;
            display: block;
        }

        /* アップロードエリア */
        .upload-area {
            border: 2px dashed var(--border-color);
            border-radius: var(--radius-md);
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--bg-warm);
        }

        .upload-area:hover {
            border-color: var(--accent-color);
            background: var(--accent-light);
        }

        .upload-area.dragover {
            border-color: var(--accent-color);
            background: var(--accent-light);
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .upload-area p {
            margin: 0;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .upload-hint {
            font-size: 12px !important;
            color: var(--text-light) !important;
            margin-top: 8px !important;
        }

        .uploaded-preview {
            text-align: center;
        }

        .uploaded-preview img {
            max-width: 100%;
            max-height: 300px;
            border-radius: var(--radius-sm);
            margin-bottom: 12px;
            border: 1px solid var(--border-color);
        }

        .workflow-history-content {
            flex: 1;
        }

        .workflow-history-title {
            font-weight: 600;
            font-size: 14px;
        }

        .workflow-history-detail {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* プロジェクト作成ボタン（一般ユーザー用） */
        .create-project-btn {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
            transition: all 0.2s;
            z-index: 40;
        }

        .create-project-btn:hover {
            transform: scale(1.1);
            background: var(--primary-hover);
        }

        /* 上長承認パネル・PJ承認者パネル */
        .approver-panel {
            background: linear-gradient(135deg, #6b46c1 0%, #553c9a 100%);
            color: white;
            padding: 20px;
            border-radius: var(--radius-md);
            margin-bottom: 24px;
        }

        .approver-panel h3 {
            font-size: 18px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .approver-panel p {
            font-size: 14px;
            opacity: 0.9;
        }

        .approver-badge {
            background: rgba(255,255,255,0.2);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            margin-left: 8px;
        }

        /* 上長承認パネル */
        .manager-panel {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .manager-panel h3 {
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .manager-badge {
            background: rgba(255,255,255,0.2);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
        }

        /* フォームモーダル */
        .form-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 300;
            padding: 20px;
        }

        .form-modal.show {
            display: flex;
        }

        .form-modal-content {
            background: white;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            border-radius: 16px;
            overflow-y: auto;
        }

        .form-modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .form-modal-body {
            padding: 20px;
        }

        .form-modal-footer {
            padding: 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        /* admin panel */
        .admin-panel {
            display: none;
        }

        .admin-panel.active {
            display: block;
        }

        /* レスポンシブ */
        @media (min-width: 768px) {
            .main-content {
                padding: 40px 20px;
            }

            .modal-content {
                border-radius: 24px;
                margin: 20px;
                max-height: calc(100vh - 40px);
            }

            .modal-overlay {
                align-items: center;
            }

            .stats-section {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (max-width: 600px) {
            .admin-table {
                font-size: 12px;
            }

            .admin-table th,
            .admin-table td {
                padding: 8px;
            }

            .action-buttons {
                flex-direction: column;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .admin-tabs {
                flex-wrap: wrap;
            }

            .admin-tab {
                min-width: 80px;
                font-size: 12px;
                padding: 10px 8px;
            }
        }

        /* アニメーション */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .fade-in {
            animation: fadeIn 0.3s ease;
        }

        /* Indeed風 2カラムレイアウト */
        .two-column-layout {
            display: flex;
            gap: 24px;
            height: calc(100vh - 64px - 70px);
            padding: 24px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .left-column {
            flex: 1;
            min-width: 380px;
            max-width: 480px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .right-column {
            flex: 1.5;
            background: white;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
            overflow-y: auto;
            position: sticky;
            top: 88px;
            max-height: calc(100vh - 64px - 70px - 48px);
        }

        .project-list-container {
            flex: 1;
            overflow-y: auto;
            padding-right: 8px;
        }

        .project-list-container::-webkit-scrollbar {
            width: 6px;
        }

        .project-list-container::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }

        .project-list-container::-webkit-scrollbar-thumb:hover {
            background: var(--text-light);
        }

        .search-filter-section {
            background: white;
            padding: 20px;
            border-radius: var(--radius-lg);
            margin-bottom: 16px;
            border: 1px solid var(--border-color);
        }

        .search-filter-section .search-input {
            padding: 14px 16px 14px 44px;
            font-size: 15px;
        }

        .search-filter-section .search-icon {
            left: 16px;
            font-size: 16px;
        }

        .filter-tabs {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .filter-tab {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid var(--border-color);
            background: white;
            color: var(--text-secondary);
        }

        .filter-tab:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        .filter-tab.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* プロジェクトカード - コンパクト版 */
        .project-card-compact {
            background: white;
            border-radius: var(--radius-md);
            padding: 16px 20px;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 12px;
        }

        .project-card-compact:hover {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 1px var(--primary-color);
        }

        .project-card-compact.selected {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px var(--primary-color);
            background: var(--accent-light);
        }

        .project-card-compact .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .project-card-compact .project-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1.4;
            margin: 0;
        }

        .project-card-compact:hover .project-title {
            color: var(--primary-color);
        }

        .project-card-compact .project-category {
            font-size: 11px;
            padding: 4px 10px;
        }

        .project-card-compact .project-description {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 12px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .project-card-compact .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: var(--text-light);
        }

        .project-card-compact .card-meta {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .project-card-compact .meta-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* 詳細パネル */
        .detail-panel {
            padding: 0;
        }

        .detail-panel-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            min-height: 400px;
            color: var(--text-light);
            text-align: center;
            padding: 40px;
        }

        .detail-panel-empty .empty-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .detail-panel-empty .empty-text {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-secondary);
        }

        .detail-panel-empty .empty-hint {
            font-size: 14px;
            color: var(--text-light);
        }

        .detail-panel-content {
            animation: fadeIn 0.2s ease;
        }

        .detail-panel-header {
            padding: 24px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-warm);
        }

        .detail-panel-header .header-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .detail-panel-header .project-title {
            font-size: 22px;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1.3;
            margin: 0;
        }

        .detail-panel-header .header-actions {
            display: flex;
            gap: 8px;
        }

        .detail-panel-header .project-meta {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .detail-panel-header .meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .detail-panel-body {
            padding: 24px;
        }

        .detail-panel-body .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .detail-panel-body .info-item {
            padding: 16px;
            background: var(--bg-color);
            border-radius: var(--radius-sm);
        }

        .detail-panel-body .info-item label {
            font-size: 12px;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
            display: block;
        }

        .detail-panel-body .info-item .value {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .detail-section-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--primary-color);
            display: inline-block;
        }

        .detail-panel-body .description-text {
            font-size: 15px;
            line-height: 1.8;
            color: var(--text-secondary);
            margin-bottom: 24px;
        }

        .skill-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 24px;
        }

        .skill-tag {
            padding: 6px 14px;
            background: var(--accent-light);
            color: var(--accent-color);
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
        }

        .members-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 24px;
        }

        .member-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-color);
            border-radius: var(--radius-sm);
        }

        .member-card .member-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
        }

        .member-card .member-info {
            flex: 1;
        }

        .member-card .member-name {
            font-weight: 600;
            font-size: 14px;
            color: var(--text-primary);
        }

        .member-card .member-role {
            font-size: 12px;
            color: var(--text-light);
        }

        .detail-panel-footer {
            padding: 20px 24px;
            border-top: 1px solid var(--border-color);
            background: white;
            position: sticky;
            bottom: 0;
        }

        .detail-panel-footer .btn {
            width: 100%;
        }

        /* レスポンシブ対応 - スマホのみ縦並び */
        @media (max-width: 600px) {
            .two-column-layout {
                flex-direction: column;
                height: auto;
            }

            .left-column {
                max-width: 100%;
                min-width: auto;
            }

            .right-column {
                position: static;
                max-height: none;
                min-height: 400px;
            }

            .project-list-container {
                max-height: 400px;
            }
        }

        /* 統計カード（2カラムレイアウト用） */
        .stats-row {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .stats-row .stat-card {
            flex: 1;
            padding: 16px;
            background: white;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
            text-align: center;
        }

        .stats-row .stat-number {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-color);
        }

        .stats-row .stat-label {
            font-size: 12px;
            color: var(--text-light);
        }
    </style>
    <!-- Supabase JavaScript Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- ログイン画面 -->
    <div class="login-overlay" id="loginOverlay">
        <div class="login-box">
            <h1>Project Portal</h1>
            <p class="subtitle">ベステラ プロジェクト管理</p>

            <!-- 統一ログインフォーム -->
            <form id="loginForm" class="login-form active">
                <div class="form-group">
                    <label>ユーザーID</label>
                    <input type="text" id="userId" placeholder="社員ID または admin" required>
                </div>
                <div class="form-group">
                    <label>パスワード</label>
                    <input type="password" id="userPassword" placeholder="パスワードを入力" required>
                </div>
                <div class="error-message" id="loginError">IDまたはパスワードが正しくありません</div>
                <button type="submit" class="btn btn-primary">ログイン</button>
            </form>
        </div>
    </div>

    <!-- 社員用アプリ -->
    <div class="app" id="userApp" style="display: none;">
        <!-- ヘッダー -->
        <header class="header">
            <div class="header-content">
                <div class="logo" onclick="showPage('my')">
                    <svg class="logo-img" viewBox="0 0 120 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="2" y="8" width="24" height="24" rx="4" fill="#2d3a4a"/>
                        <path d="M8 20L12 24L20 16" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                        <text x="32" y="26" font-family="Arial" font-size="16" font-weight="bold" fill="#2d3a4a">BESTERRA</text>
                    </svg>
                    <div class="logo-text">
                        <span class="logo-main">Project Portal</span>
                        <span class="logo-sub">プロジェクト管理</span>
                    </div>
                </div>
                <div class="user-menu">
                    <div class="user-dropdown">
                        <div class="user-avatar" id="userAvatar" onclick="toggleDropdown('userDropdown')">テ</div>
                        <div class="dropdown-menu" id="userDropdown">
                            <div class="dropdown-header">
                                <div class="dropdown-header-name" id="userNameDisplay">テストユーザ</div>
                                <div class="dropdown-header-dept" id="userDeptDisplay">テスト部署</div>
                            </div>
                            <div class="dropdown-item" onclick="showPage('my')">👤 マイページ</div>
                            <div class="dropdown-item danger" onclick="logout()">🚪 ログアウト</div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- ホームページ（Indeed風2カラムレイアウト） -->
        <div class="two-column-layout page" id="homePage">
            <!-- 左カラム：検索・フィルター・プロジェクト一覧 -->
            <div class="left-column">
                <!-- 統計カード -->
                <div class="stats-row">
                    <div class="stat-card">
                        <div class="stat-number" id="totalProjects">12</div>
                        <div class="stat-label">全プロジェクト</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="myProjectsCount">3</div>
                        <div class="stat-label">参加中</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="recruiting">5</div>
                        <div class="stat-label">募集中</div>
                    </div>
                </div>

                <!-- 検索・フィルター -->
                <div class="search-filter-section">
                    <div class="search-input-wrapper">
                        <span class="search-icon">🔎</span>
                        <input type="text" class="search-input" placeholder="プロジェクトを検索..." id="searchInput">
                    </div>
                    <div class="filter-tabs">
                        <div class="filter-tab active" data-tab="company" onclick="switchTab('company')">全社</div>
                        <div class="filter-tab" data-tab="department" onclick="switchTab('department')">部署</div>
                        <div class="filter-tab" data-tab="other" onclick="switchTab('other')">その他</div>
                    </div>
                </div>

                <!-- プロジェクト一覧 -->
                <div class="project-list-container">
                    <div class="project-list" id="projectList">
                        <!-- JavaScriptで動的に生成 -->
                    </div>
                </div>
            </div>

            <!-- 右カラム：プロジェクト詳細パネル -->
            <div class="right-column">
                <div class="detail-panel" id="detailPanel">
                    <div class="detail-panel-empty" id="detailPanelEmpty">
                        <div class="empty-icon">📋</div>
                        <div class="empty-text">プロジェクトを選択してください</div>
                        <div class="empty-hint">左のリストからプロジェクトをクリックすると詳細が表示されます</div>
                    </div>
                    <div class="detail-panel-content" id="detailPanelContent" style="display: none;">
                        <!-- JavaScriptで動的に生成 -->
                    </div>
                </div>
            </div>
        </div>

        <!-- マイページ -->
        <main class="main-content page active" id="myPage">
            <h2 style="margin-bottom: 20px;">マイページ</h2>

            <div class="stats-section">
                <div class="stat-card">
                    <div class="stat-number">3</div>
                    <div class="stat-label">参加中</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="pendingCount">1</div>
                    <div class="stat-label">申請中</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">5</div>
                    <div class="stat-label">過去参加</div>
                </div>
            </div>

            <div class="my-projects">
                <h2>参加中のプロジェクト</h2>
                <div id="myProjectsList"></div>
            </div>

            <div class="my-projects">
                <h2>参加申請中</h2>
                <div id="myApplicationsList"></div>
            </div>

            <div class="my-projects">
                <h2>📝 自分のプロジェクト企画</h2>
                <div id="myProposalsList"></div>
            </div>
        </main>

        <!-- 通知ページ -->
        <main class="main-content page" id="notificationPage">
            <h2 style="margin-bottom: 20px;">通知</h2>
            <div id="notificationList"></div>
        </main>

        <!-- 上長承認ページ -->
        <main class="main-content page" id="managerPage">
            <div class="manager-panel">
                <h3>📋 上長承認<span class="manager-badge">承認待ち</span></h3>
                <p>部下から提出されたプロジェクト企画を確認・承認してください</p>
            </div>

            <div class="admin-section">
                <h2 style="font-size: 16px; margin-bottom: 16px;">承認待ちプロジェクト企画</h2>
                <div id="managerApprovalList"></div>
            </div>
        </main>

        <!-- PJ承認者ページ -->
        <main class="main-content page" id="approverPage">
            <div class="approver-panel">
                <h3>🔖 PJ承認<span class="approver-badge">承認待ち</span></h3>
                <p>あなたがPJ承認者として指定されたプロジェクト企画を確認・承認してください</p>
            </div>

            <div class="admin-section">
                <h2 style="font-size: 16px; margin-bottom: 16px;">承認待ちプロジェクト企画</h2>
                <div id="approverApprovalsList"></div>
            </div>
        </main>

        <!-- プロジェクト作成ボタン -->
        <button class="create-project-btn" id="createProjectBtn" onclick="openUserProjectForm()" title="プロジェクト企画を作成">+</button>

        <!-- フッターナビ -->
        <nav class="bottom-nav">
            <div class="nav-item" id="managerNavItem" style="display: none;" onclick="showPage('manager')">
                <span class="nav-icon">📋</span>
                <span class="nav-label">上長承認</span>
            </div>
            <div class="nav-item" id="approverNavItem" style="display: none;" onclick="showPage('approver')">
                <span class="nav-icon">🔖</span>
                <span class="nav-label">PJ承認</span>
            </div>
            <div class="nav-item notification-badge" data-count="3" onclick="showPage('notification')">
                <span class="nav-icon">🔔</span>
                <span class="nav-label">通知</span>
            </div>
        </nav>
    </div>

    <!-- 管理者用アプリ -->
    <div class="app" id="adminApp" style="display: none;">
        <!-- 管理者ヘッダー -->
        <header class="header admin-header">
            <div class="header-content">
                <div class="logo">
                    Project Portal
                    <span class="admin-badge">管理者</span>
                </div>
                <div class="user-menu">
                    <div class="user-dropdown">
                        <div class="user-avatar" id="adminAvatar">管</div>
                        <div class="dropdown-menu" id="adminDropdown">
                            <div class="dropdown-item danger" onclick="logout()">ログアウト</div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- 管理者メインコンテンツ -->
        <main class="main-content admin-content">
            <!-- 統計 -->
            <div class="stats-section">
                <div class="stat-card">
                    <div class="stat-number" id="adminTotalProjects">12</div>
                    <div class="stat-label">全プロジェクト</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="adminTotalUsers">5</div>
                    <div class="stat-label">登録ユーザー</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="adminPendingApplications">3</div>
                    <div class="stat-label">申請待ち</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="adminTotalMembers">45</div>
                    <div class="stat-label">参加者数</div>
                </div>
            </div>

            <!-- 管理者タブ -->
            <div class="admin-tabs">
                <div class="admin-tab active" onclick="switchAdminPanel('projects')">プロジェクト</div>
                <div class="admin-tab" onclick="switchAdminPanel('workflow')">企画承認</div>
                <div class="admin-tab" onclick="switchAdminPanel('applications')">参加申請</div>
                <div class="admin-tab" onclick="switchAdminPanel('users')">ユーザー管理</div>
            </div>

            <!-- プロジェクト管理パネル -->
            <div class="admin-panel active" id="projectsPanel">
                <div class="admin-section">
                    <h2>📋 プロジェクト管理</h2>
                    <div style="margin-bottom: 16px;">
                        <button class="btn btn-success" onclick="openProjectForm()">+ 新規プロジェクト作成</button>
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="admin-table" id="adminProjectTable">
                            <thead>
                                <tr>
                                    <th>プロジェクト名</th>
                                    <th>カテゴリ</th>
                                    <th>定員</th>
                                    <th>ステータス</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="adminProjectList">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ワークフロー承認パネル -->
            <div class="admin-panel" id="workflowPanel">
                <div class="admin-section">
                    <h2>📋 プロジェクト企画承認（最終承認）</h2>
                    <p style="color: var(--text-secondary); margin-bottom: 16px; font-size: 14px;">
                        上長承認済みのプロジェクト企画を最終承認してください。承認されたプロジェクトは正式に公開されます。
                    </p>
                    <div style="overflow-x: auto;">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>プロジェクト名</th>
                                    <th>申請者</th>
                                    <th>カテゴリ</th>
                                    <th>上長承認</th>
                                    <th>ステータス</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="adminWorkflowList">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 参加申請管理パネル -->
            <div class="admin-panel" id="applicationsPanel">
                <div class="admin-section">
                    <h2>📝 参加申請管理</h2>
                    <div style="overflow-x: auto;">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>申請者</th>
                                    <th>プロジェクト</th>
                                    <th>申請日</th>
                                    <th>ステータス</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="applicationList">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ユーザー管理パネル -->
            <div class="admin-panel" id="usersPanel">
                <div class="admin-section">
                    <h2>👥 ユーザー管理</h2>
                    <div style="margin-bottom: 16px;">
                        <button class="btn btn-success" onclick="openUserForm()">+ 新規ユーザー登録</button>
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>社員ID</th>
                                    <th>名前</th>
                                    <th>部署</th>
                                    <th>権限</th>
                                    <th>ステータス</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="userList">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- プロジェクト詳細モーダル -->
    <div class="modal-overlay" id="modalOverlay" onclick="closeModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2 id="modalTitle">プロジェクト名</h2>
                <button class="modal-close" onclick="closeModal()">×</button>
            </div>
            <div class="modal-body" id="modalBody">
            </div>
            <div class="modal-footer" id="modalFooter">
                <button class="btn btn-outline" onclick="closeModal()">閉じる</button>
                <button class="btn btn-success" id="applyBtn" onclick="applyProject()">参加申請</button>
            </div>
        </div>
    </div>

    <!-- 申請完了モーダル -->
    <div class="modal-overlay" id="successOverlay" style="display: none; align-items: center;">
        <div class="success-modal show">
            <div class="success-icon">✓</div>
            <h2 id="successTitle">申請完了</h2>
            <p id="successMessage" style="color: var(--text-secondary); margin: 16px 0;">参加申請を送信しました。<br>承認までしばらくお待ちください。</p>
            <button class="btn btn-primary" onclick="closeSuccessModal()">OK</button>
        </div>
    </div>

    <!-- プロジェクト作成/編集モーダル -->
    <div class="form-modal" id="projectFormModal">
        <div class="form-modal-content">
            <div class="form-modal-header">
                <h2 id="projectFormTitle">新規プロジェクト作成</h2>
                <button class="modal-close" onclick="closeProjectForm()">×</button>
            </div>
            <div class="form-modal-body">
                <form id="projectForm">
                    <input type="hidden" id="projectId">
                    <div class="form-group">
                        <label>プロジェクト名 *</label>
                        <input type="text" id="projectTitle" required>
                    </div>
                    <div class="form-group">
                        <label>カテゴリ *</label>
                        <select id="projectCategory" required>
                            <option value="company">全社プロジェクト</option>
                            <option value="department">部署プロジェクト</option>
                            <option value="other">その他（社員活動）</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>説明 *</label>
                        <textarea id="projectDescription" required></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>アイコン（絵文字）</label>
                            <input type="text" id="projectIcon" placeholder="例: 🏗️" maxlength="2">
                        </div>
                        <div class="form-group">
                            <label>定員 *</label>
                            <input type="number" id="projectCapacity" min="1" max="100" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>リーダー名 *</label>
                            <input type="text" id="projectLeader" required>
                        </div>
                        <div class="form-group">
                            <label>担当部署 *</label>
                            <input type="text" id="projectDepartment" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>開始日</label>
                            <input type="text" id="projectStartDate" placeholder="例: 2024/01/01">
                        </div>
                        <div class="form-group">
                            <label>終了日</label>
                            <input type="text" id="projectEndDate" placeholder="例: 2024/12/31">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>ステータス</label>
                        <select id="projectStatus">
                            <option value="recruiting">募集中</option>
                            <option value="ongoing">進行中</option>
                            <option value="closed">終了</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>求めるスキル（カンマ区切り）</label>
                        <input type="text" id="projectSkills" placeholder="例: プロジェクト管理, データ分析">
                    </div>
                </form>
            </div>
            <div class="form-modal-footer">
                <button class="btn btn-outline" onclick="closeProjectForm()">キャンセル</button>
                <button class="btn btn-success" onclick="saveProject()">保存</button>
            </div>
        </div>
    </div>

    <!-- ユーザー作成/編集モーダル -->
    <div class="form-modal" id="userFormModal">
        <div class="form-modal-content">
            <div class="form-modal-header">
                <h2 id="userFormTitle">新規ユーザー登録</h2>
                <button class="modal-close" onclick="closeUserForm()">×</button>
            </div>
            <div class="form-modal-body">
                <form id="userForm">
                    <input type="hidden" id="editUserId">
                    <div class="form-group">
                        <label>社員ID *</label>
                        <input type="text" id="newUserId" placeholder="例: 1002" required>
                    </div>
                    <div class="form-group">
                        <label>名前 *</label>
                        <input type="text" id="newUserName" placeholder="例: 山田太郎" required>
                    </div>
                    <div class="form-group">
                        <label>パスワード *</label>
                        <input type="password" id="newUserPassword" placeholder="パスワードを入力" required>
                    </div>
                    <div class="form-group">
                        <label>部署 *</label>
                        <select id="newUserDepartment" required>
                            <option value="">選択してください</option>
                            <option value="executive">代表者</option>
                            <option value="plant_hq">プラント事業本部</option>
                            <option value="construction">工事部</option>
                            <option value="construction_staff">工事部付</option>
                            <option value="hq_office">本社事務所</option>
                            <option value="chiba_office">千葉事務所</option>
                            <option value="jfe_chiba">JFE千葉構内作業所</option>
                            <option value="keihin_office">京浜事務所</option>
                            <option value="west_japan_office">西日本事務所</option>
                            <option value="kurashiki_office">倉敷作業所</option>
                            <option value="kyushu_office">九州事務所</option>
                            <option value="construction_planning">工事計画室</option>
                            <option value="safety">安全衛生室</option>
                            <option value="engineering">工務部</option>
                            <option value="sales">営業部</option>
                            <option value="sales_section">営業課</option>
                            <option value="marketing">マーケティング部</option>
                            <option value="procurement">調達室</option>
                            <option value="decarbonization">脱炭素事業推進部</option>
                            <option value="3d_measurement">3D計測室</option>
                            <option value="management_hq">経営企画本部</option>
                            <option value="planning">企画部</option>
                            <option value="admin_dept">管理部</option>
                            <option value="general_affairs">総務課</option>
                            <option value="finance">経理財務課</option>
                            <option value="hr">人事部</option>
                            <option value="hr_section">人事課</option>
                            <option value="president_office">社長室</option>
                            <option value="none">所属部署なし</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>メールアドレス</label>
                        <input type="email" id="newUserEmail" placeholder="例: yamada@besterra.co.jp">
                    </div>
                    <div class="form-group">
                        <label>権限 *</label>
                        <select id="newUserRole" required onchange="toggleManagerSelect()">
                            <option value="user">一般ユーザー</option>
                            <option value="manager">上長（部長・課長）</option>
                            <option value="admin">管理者</option>
                        </select>
                    </div>
                    <div class="form-group" id="managerSelectGroup">
                        <label>上長（承認者）</label>
                        <select id="newUserManagerId">
                            <option value="">選択してください</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ステータス</label>
                        <select id="newUserStatus">
                            <option value="active">有効</option>
                            <option value="inactive">無効</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="form-modal-footer">
                <button class="btn btn-outline" onclick="closeUserForm()">キャンセル</button>
                <button class="btn btn-success" onclick="saveUser()">保存</button>
            </div>
        </div>
    </div>

    <!-- 一般ユーザー用プロジェクト企画フォーム -->
    <div class="form-modal" id="userProjectFormModal">
        <div class="form-modal-content">
            <div class="form-modal-header">
                <h2>📝 プロジェクト企画申請</h2>
                <button class="modal-close" onclick="closeUserProjectForm()">×</button>
            </div>
            <div class="form-modal-body">
                <div class="workflow-info-box">
                    <strong>ワークフロー：</strong>申請 → 上長承認 → 管理者承認 → 公開
                </div>
                <form id="userProjectForm">
                    <div class="form-group">
                        <label>プロジェクト名 *</label>
                        <input type="text" id="userProjectTitle" required oninput="updateImagePreview()">
                    </div>
                    <div class="form-group">
                        <label>カテゴリ *</label>
                        <select id="userProjectCategory" required onchange="updateImagePreview()">
                            <option value="company">全社プロジェクト</option>
                            <option value="department">部署プロジェクト</option>
                            <option value="other">その他（社員活動）</option>
                        </select>
                    </div>

                    <!-- 画像設定セクション -->
                    <div class="image-settings-section">
                        <label class="section-label">🖼️ プロジェクト画像</label>
                        <p class="image-size-info">推奨サイズ: <strong>600 × 400 ピクセル</strong>（横長・3:2比率）</p>

                        <div class="image-option-tabs">
                            <button type="button" class="image-option-tab active" onclick="switchImageOption('auto')">
                                自動生成
                            </button>
                            <button type="button" class="image-option-tab" onclick="switchImageOption('upload')">
                                画像をアップロード
                            </button>
                        </div>

                        <!-- 自動生成オプション -->
                        <div class="image-option-content" id="imageOptionAuto">
                            <div class="auto-image-settings">
                                <div class="form-group">
                                    <label>背景スタイル</label>
                                    <select id="imageStyle" onchange="updateImagePreview()">
                                        <option value="gradient1">グラデーション（ブルー）</option>
                                        <option value="gradient2">グラデーション（グリーン）</option>
                                        <option value="gradient3">グラデーション（パープル）</option>
                                        <option value="gradient4">グラデーション（オレンジ）</option>
                                        <option value="solid1">ソリッド（ダークグレー）</option>
                                        <option value="solid2">ソリッド（ネイビー）</option>
                                        <option value="pattern1">パターン（ドット）</option>
                                        <option value="pattern2">パターン（ライン）</option>
                                    </select>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>アイコン（絵文字）</label>
                                        <input type="text" id="userProjectIcon" placeholder="例: 🚀" maxlength="4" oninput="updateImagePreview()">
                                    </div>
                                    <div class="form-group">
                                        <label>アイコンサイズ</label>
                                        <select id="iconSize" onchange="updateImagePreview()">
                                            <option value="small">小</option>
                                            <option value="medium" selected>中</option>
                                            <option value="large">大</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="image-preview-container">
                                <label>プレビュー</label>
                                <div class="image-preview" id="autoImagePreview">
                                    <canvas id="previewCanvas" width="600" height="400"></canvas>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline" onclick="regenerateImage()">
                                    🔄 再生成
                                </button>
                            </div>
                        </div>

                        <!-- アップロードオプション -->
                        <div class="image-option-content hidden" id="imageOptionUpload">
                            <div class="upload-area" id="uploadArea" onclick="document.getElementById('imageUpload').click()">
                                <div class="upload-icon">📤</div>
                                <p>クリックまたはドラッグ＆ドロップで画像をアップロード</p>
                                <p class="upload-hint">推奨: 600×400px / JPG, PNG形式 / 最大5MB</p>
                                <input type="file" id="imageUpload" accept="image/*" hidden onchange="handleImageUpload(event)">
                            </div>
                            <div class="uploaded-preview hidden" id="uploadedPreview">
                                <img id="uploadedImage" src="" alt="アップロード画像">
                                <button type="button" class="btn btn-sm btn-danger" onclick="removeUploadedImage()">
                                    🗑️ 削除
                                </button>
                            </div>
                        </div>

                        <input type="hidden" id="projectImageData" value="">
                    </div>

                    <div class="form-group">
                        <label>説明 *</label>
                        <textarea id="userProjectDescription" placeholder="プロジェクトの目的や内容を記入してください" required></textarea>
                    </div>
                    <div class="form-group">
                        <label>希望定員 *</label>
                        <input type="number" id="userProjectCapacity" min="1" max="100" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>開始予定日</label>
                            <input type="text" id="userProjectStartDate" placeholder="例: 2024/04/01">
                        </div>
                        <div class="form-group">
                            <label>終了予定日</label>
                            <input type="text" id="userProjectEndDate" placeholder="例: 2025/03/31">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>求めるスキル（カンマ区切り）</label>
                        <input type="text" id="userProjectSkills" placeholder="例: 企画, コミュニケーション">
                    </div>

                    <!-- ワークフロー設定 -->
                    <div class="workflow-settings-section">
                        <label class="section-label">📋 ワークフロー設定</label>
                        <div class="workflow-steps-preview">
                            <div class="workflow-step">
                                <span class="step-number">1</span>
                                <span class="step-label">申請者（あなた）</span>
                            </div>
                            <div class="workflow-arrow">→</div>
                            <div class="workflow-step">
                                <span class="step-number">2</span>
                                <span class="step-label">上長承認</span>
                            </div>
                            <div class="workflow-arrow">→</div>
                            <div class="workflow-step">
                                <span class="step-number">3</span>
                                <span class="step-label">PJ承認者</span>
                            </div>
                            <div class="workflow-arrow">→</div>
                            <div class="workflow-step">
                                <span class="step-number">4</span>
                                <span class="step-label">システム管理者</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>① 上長（自動設定）</label>
                            <input type="text" id="userProjectManager" disabled>
                        </div>
                        <div class="form-group">
                            <label>② プロジェクト承認者 *</label>
                            <select id="userProjectApprover" required>
                                <option value="">-- 選択してください --</option>
                            </select>
                            <p class="form-hint">プロジェクトを承認する責任者を選択してください（部長・本部長など）</p>
                        </div>
                        <div class="form-group">
                            <label>③ システム管理者（自動）</label>
                            <input type="text" value="システム管理者" disabled>
                        </div>
                    </div>
                </form>
            </div>
            <div class="form-modal-footer">
                <button class="btn btn-outline" onclick="closeUserProjectForm()">キャンセル</button>
                <button class="btn btn-primary" onclick="submitProjectProposal()">申請する</button>
            </div>
        </div>
    </div>

    <!-- ワークフロー詳細モーダル -->
    <div class="form-modal" id="workflowDetailModal">
        <div class="form-modal-content">
            <div class="form-modal-header">
                <h2 id="workflowDetailTitle">プロジェクト企画詳細</h2>
                <button class="modal-close" onclick="closeWorkflowDetail()">×</button>
            </div>
            <div class="form-modal-body" id="workflowDetailBody">
            </div>
            <div class="form-modal-footer" id="workflowDetailFooter">
            </div>
        </div>
    </div>

    <!-- 削除確認モーダル -->
    <div class="form-modal" id="deleteConfirmModal">
        <div class="form-modal-content" style="max-width: 400px;">
            <div class="form-modal-header">
                <h2>削除の確認</h2>
                <button class="modal-close" onclick="closeDeleteConfirm()">×</button>
            </div>
            <div class="form-modal-body">
                <p id="deleteConfirmMessage">本当に削除しますか？</p>
                <p style="color: var(--danger-color); margin-top: 12px; font-size: 14px;">この操作は取り消せません。</p>
            </div>
            <div class="form-modal-footer">
                <button class="btn btn-outline" onclick="closeDeleteConfirm()">キャンセル</button>
                <button class="btn btn-danger" onclick="confirmDelete()">削除する</button>
            </div>
        </div>
    </div>

    <script>
        // ================================================
        // Supabase 設定
        // ================================================
        const SUPABASE_URL = 'https://qaovbyxmrnnczjqubxzi.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFhb3ZieXhtcm5uY3pqcXVieHppIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxMjg3MjYsImV4cCI6MjA4MTcwNDcyNn0.txuO6bJ4lY_opxnP4LG1p_-3YghSww4yxHTIw8Khw84';

        // Supabaseクライアント初期化
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // データベースモード（true: Supabase使用, false: ローカルデータ使用）
        let useDatabase = false;

        // 管理者認証情報
        const ADMIN_CREDENTIALS = {
            id: 'admin',
            password: 'besterra'
        };

        // ユーザーデータ（manager: 上長、managerId: 上長のユーザーID）
        // 全社員データ - パスワードは全員 0001
        let users = [
            { id: '1001', name: '吉野 佳秀', password: '0001', department: 'executive', departmentName: '代表者', role: 'manager', status: 'active', email: 'yoshino@besterra.co.jp', managerId: null },
            { id: '1005', name: '五代 俊昭', password: '0001', department: 'plant_hq', departmentName: 'プラント事業本部', role: 'manager', status: 'active', email: 'godai@besterra.co.jp', managerId: null },
            { id: '1010', name: '本田 豊', password: '0001', department: 'executive', departmentName: '代表者', role: 'manager', status: 'active', email: 'yhonda@besterra.co.jp', managerId: null },
            { id: '1011', name: '天沼 周次郎', password: '0001', department: 'plant_hq', departmentName: 'プラント事業本部', role: 'manager', status: 'active', email: 's.amanuma@besterra.co.jp', managerId: null },
            { id: '1014', name: '長 泰治', password: '0001', department: 'executive', departmentName: '代表者', role: 'manager', status: 'active', email: 'cho@besterra.co.jp', managerId: null },
            { id: '1015', name: '関谷 竜一', password: '0001', department: 'sales', departmentName: '営業部', role: 'manager', status: 'active', email: 'r.sekiya@besterra.co.jp', managerId: null },
            { id: '1017', name: '橋本 正男', password: '0001', department: 'sales', departmentName: '営業部', role: 'manager', status: 'active', email: 'm.hashimoto@besterra.co.jp', managerId: null },
            { id: '1020', name: '込山 雅弘', password: '0001', department: 'executive', departmentName: '代表者', role: 'user', status: 'active', email: 'm.komiyama@besterra.co.jp', managerId: null },
            { id: '2002', name: '仲村 淸美', password: '0001', department: 'president_office', departmentName: '社長室', role: 'user', status: 'active', email: 'nakamura@besterra.co.jp', managerId: null },
            { id: '2004', name: '木村 勇', password: '0001', department: 'construction_staff', departmentName: '工事部付', role: 'manager', status: 'active', email: 'kimura@besterra.co.jp', managerId: null },
            { id: '2007', name: '竹内 信広', password: '0001', department: 'chiba_office', departmentName: '千葉事務所', role: 'manager', status: 'active', email: 'takeuchi@besterra.co.jp', managerId: null },
            { id: '2009', name: '野上 有実子', password: '0001', department: 'hq_office', departmentName: '本社事務所', role: 'manager', status: 'active', email: 'nogami@besterra.co.jp', managerId: null },
            { id: '2012', name: '荒木 伸治', password: '0001', department: 'engineering', departmentName: '工務部', role: 'manager', status: 'active', email: 'araki@besterra.co.jp', managerId: null },
            { id: '2013', name: '井上 貴之', password: '0001', department: 'plant_hq', departmentName: 'プラント事業本部', role: 'manager', status: 'active', email: 'inoue@besterra.co.jp', managerId: null },
            { id: '2018', name: '中市 美輝', password: '0001', department: 'chiba_office', departmentName: '千葉事務所', role: 'manager', status: 'active', email: 'y.nakaichi@besterra.co.jp', managerId: null },
            { id: '2021', name: '小林 大祐', password: '0001', department: 'procurement', departmentName: '調達室', role: 'manager', status: 'active', email: 'd.kobayashi@besterra.co.jp', managerId: null },
            { id: '2025', name: '佐々木 力', password: '0001', department: 'construction_staff', departmentName: '工事部付', role: 'manager', status: 'active', email: 'tsasaki@besterra.co.jp', managerId: null },
            { id: '2026', name: '深川 秀之', password: '0001', department: 'construction', departmentName: '工事部', role: 'manager', status: 'active', email: 'hfukagawa@besterra.co.jp', managerId: null },
            { id: '2034', name: '池田 真也', password: '0001', department: 'admin_dept', departmentName: '管理部', role: 'manager', status: 'active', email: 's.ikeda@besterra.co.jp', managerId: null },
            { id: '2035', name: '青木 良明', password: '0001', department: 'general_affairs', departmentName: '総務課', role: 'user', status: 'active', email: 'y.aoki@besterra.co.jp', managerId: null },
            { id: '2037', name: '葛西 健太郎', password: '0001', department: 'engineering', departmentName: '工務部', role: 'user', status: 'active', email: 'k.kasai@besterra.co.jp', managerId: null },
            { id: '2042', name: '今元 翔太郎', password: '0001', department: 'chiba_office', departmentName: '千葉事務所', role: 'user', status: 'active', email: 's.imamoto@besterra.co.jp', managerId: null },
            { id: '2043', name: '水戸 義織', password: '0001', department: 'hq_office', departmentName: '本社事務所', role: 'user', status: 'active', email: 'y.mito@besterra.co.jp', managerId: null },
            { id: '2046', name: '川地 貴仁', password: '0001', department: 'construction', departmentName: '工事部', role: 'manager', status: 'active', email: 't.kawachi@besterra.co.jp', managerId: null },
            { id: '2053', name: '齊藤 龍一', password: '0001', department: 'construction_planning', departmentName: '工事計画室', role: 'user', status: 'active', email: 'r.saito@besterra.co.jp', managerId: null },
            { id: '2054', name: '前原 昭仁', password: '0001', department: 'president_office', departmentName: '社長室', role: 'manager', status: 'active', email: 'a.maehara@besterra.co.jp', managerId: null },
            { id: '2056', name: '中楯 和男', password: '0001', department: '3d_measurement', departmentName: '3D計測室', role: 'user', status: 'active', email: 'k.nakadate@besterra.co.jp', managerId: null },
            { id: '2057', name: '宝崎 順一', password: '0001', department: 'finance', departmentName: '経理財務課', role: 'manager', status: 'active', email: 'j.houzaki@besterra.co.jp', managerId: null },
            { id: '2061', name: '三谷 慎太郎', password: '0001', department: 'west_japan_office', departmentName: '西日本事務所', role: 'user', status: 'active', email: 's.mitani@besterra.co.jp', managerId: null },
            { id: '2062', name: '熊耳 紀明', password: '0001', department: 'keihin_office', departmentName: '京浜事務所', role: 'user', status: 'active', email: 'n.kumagami@besterra.co.jp', managerId: null },
            { id: '2063', name: '沼田 秀一郎', password: '0001', department: 'chiba_office', departmentName: '千葉事務所', role: 'user', status: 'active', email: 's.numata@besterra.co.jp', managerId: null },
            { id: '2068', name: '張 在皓', password: '0001', department: 'construction_planning', departmentName: '工事計画室', role: 'manager', status: 'active', email: 'j.jang@besterra.co.jp', managerId: null },
            { id: '2070', name: '大柿 直也', password: '0001', department: 'jfe_chiba', departmentName: 'JFE千葉構内作業所', role: 'manager', status: 'active', email: 'n.oogaki@besterra.co.jp', managerId: null },
            { id: '2071', name: '藤原 左京', password: '0001', department: 'keihin_office', departmentName: '京浜事務所', role: 'user', status: 'active', email: 's.fujiwara@besterra.co.jp', managerId: null },
            { id: '2072', name: '水内 勇一', password: '0001', department: 'keihin_office', departmentName: '京浜事務所', role: 'user', status: 'active', email: 'ymizuuchi@besterra.co.jp', managerId: null },
            { id: '2073', name: '青木 麻理子', password: '0001', department: 'hq_office', departmentName: '本社事務所', role: 'user', status: 'active', email: 'm.aoki@besterra.co.jp', managerId: null },
            { id: '2074', name: '小澤 健', password: '0001', department: 'hq_office', departmentName: '本社事務所', role: 'manager', status: 'active', email: 't.ozawa@besterra.co.jp', managerId: null },
            { id: '2077', name: '冨松 一郎', password: '0001', department: 'sales_section', departmentName: '営業課', role: 'manager', status: 'active', email: 'i.tomimatsu@besterra.co.jp', managerId: null },
            { id: '2079', name: '小林 亮介', password: '0001', department: 'chiba_office', departmentName: '千葉事務所', role: 'user', status: 'active', email: 'r.kobayashi@besterra.co.jp', managerId: null },
            { id: '2080', name: '原島 篤也', password: '0001', department: 'procurement', departmentName: '調達室', role: 'user', status: 'active', email: 'a.harashima@besterra.co.jp', managerId: null },
            { id: '2082', name: '坂本 匡司', password: '0001', department: 'admin_dept', departmentName: '管理部', role: 'manager', status: 'active', email: 'm.sakamoto@besterra.co.jp', managerId: null },
            { id: '2086', name: '蔵増 卓矢', password: '0001', department: 'hq_office', departmentName: '本社事務所', role: 'user', status: 'active', email: 't.kuramasu@besterra.co.jp', managerId: null },
            { id: '2090', name: '髙橋 正則', password: '0001', department: 'keihin_office', departmentName: '京浜事務所', role: 'user', status: 'active', email: 'm.takahashi@besterra.co.jp', managerId: null },
            { id: '2091', name: '小林 勇貴', password: '0001', department: 'keihin_office', departmentName: '京浜事務所', role: 'manager', status: 'active', email: 'y.kobayashi@besterra.co.jp', managerId: null },
            { id: '2092', name: '杉原 輝美', password: '0001', department: '3d_measurement', departmentName: '3D計測室', role: 'user', status: 'active', email: 't.sugihara@besterra.co.jp', managerId: null },
            { id: '2093', name: '友野 達也', password: '0001', department: 'chiba_office', departmentName: '千葉事務所', role: 'user', status: 'active', email: 't.tomono@besterra.co.jp', managerId: null },
            { id: '2098', name: '齋藤 忠', password: '0001', department: 'chiba_office', departmentName: '千葉事務所', role: 'user', status: 'active', email: 't.saito@besterra.co.jp', managerId: null },
            { id: '2107', name: '関根 大樹', password: '0001', department: '3d_measurement', departmentName: '3D計測室', role: 'user', status: 'active', email: 'd.sekine@besterra.co.jp', managerId: null },
            { id: '2109', name: '松木 忍', password: '0001', department: 'keihin_office', departmentName: '京浜事務所', role: 'user', status: 'active', email: 's.matsuki@besterra.co.jp', managerId: null },
            { id: '2110', name: '水野 陽介', password: '0001', department: 'chiba_office', departmentName: '千葉事務所', role: 'user', status: 'active', email: 'y.mizuno@besterra.co.jp', managerId: null },
            { id: '2113', name: '服部 祐弥', password: '0001', department: 'kyushu_office', departmentName: '九州事務所', role: 'user', status: 'active', email: 'y.hattori@besterra.co.jp', managerId: null },
            { id: '2114', name: '和田 雅敏', password: '0001', department: 'keihin_office', departmentName: '京浜事務所', role: 'user', status: 'active', email: 'm.wada@besterra.co.jp', managerId: null },
            { id: '2117', name: '幸田 信行', password: '0001', department: 'kyushu_office', departmentName: '九州事務所', role: 'manager', status: 'active', email: 'n.kouda@besterra.co.jp', managerId: null },
            { id: '2118', name: '有村 竜一', password: '0001', department: 'west_japan_office', departmentName: '西日本事務所', role: 'user', status: 'active', email: 'r.arimura@besterra.co.jp', managerId: null },
            { id: '2119', name: '小関 徹也', password: '0001', department: 'hq_office', departmentName: '本社事務所', role: 'user', status: 'active', email: 't.ozeki@besterra.co.jp', managerId: null },
            { id: '2122', name: '関野 政治', password: '0001', department: '3d_measurement', departmentName: '3D計測室', role: 'user', status: 'active', email: 'm.sekino@besterra.co.jp', managerId: null },
            { id: '2125', name: '田中 正弘', password: '0001', department: 'safety', departmentName: '安全衛生室', role: 'user', status: 'active', email: 'm.tanaka@besterra.co.jp', managerId: null },
            { id: '2126', name: '坪井 裕樹', password: '0001', department: 'kurashiki_office', departmentName: '倉敷作業所', role: 'manager', status: 'active', email: 'h.tsuboi@besterra.co.jp', managerId: null },
            { id: '2127', name: '古川 浩二', password: '0001', department: 'hq_office', departmentName: '本社事務所', role: 'manager', status: 'active', email: 'k.furukawa@besterra.co.jp', managerId: null },
            { id: '2133', name: '齊藤 真一', password: '0001', department: 'hq_office', departmentName: '本社事務所', role: 'manager', status: 'active', email: 's.saito@besterra.co.jp', managerId: null },
            { id: '2137', name: '木村 裕治', password: '0001', department: 'chiba_office', departmentName: '千葉事務所', role: 'user', status: 'active', email: 'y.kimura@besterra.co.jp', managerId: null },
            { id: '2138', name: '米川 尚人', password: '0001', department: 'keihin_office', departmentName: '京浜事務所', role: 'user', status: 'active', email: 'n.yonekawa@besterra.co.jp', managerId: null },
            { id: '2139', name: '原田 友洋', password: '0001', department: 'chiba_office', departmentName: '千葉事務所', role: 'user', status: 'active', email: 't.harada@besterra.co.jp', managerId: null },
            { id: '2140', name: '姉川 智也', password: '0001', department: 'west_japan_office', departmentName: '西日本事務所', role: 'manager', status: 'active', email: 't.anegawa@besterra.co.jp', managerId: null },
            { id: '2141', name: '鍋 昌勝', password: '0001', department: 'chiba_office', departmentName: '千葉事務所', role: 'user', status: 'active', email: 'm.nabe@besterra.co.jp', managerId: null },
            { id: '2142', name: '曽利田 光紀', password: '0001', department: 'west_japan_office', departmentName: '西日本事務所', role: 'user', status: 'active', email: 'k.sorida@besterra.co.jp', managerId: null },
            { id: '2143', name: '髙橋 ゆみ子', password: '0001', department: 'finance', departmentName: '経理財務課', role: 'user', status: 'active', email: 'y.takahashi@besterra.co.jp', managerId: null },
            { id: '2144', name: '石井 すずな', password: '0001', department: 'hr_section', departmentName: '人事課', role: 'user', status: 'active', email: 's.ishii@besterra.co.jp', managerId: null },
            { id: '2145', name: '石川 達也', password: '0001', department: 'planning', departmentName: '企画部', role: 'manager', status: 'active', email: 't.ishikawa@besterra.co.jp', managerId: null },
            { id: '2146', name: '木暮 諒', password: '0001', department: 'hq_office', departmentName: '本社事務所', role: 'user', status: 'active', email: 'r.kogure@besterra.co.jp', managerId: null },
            { id: '2147', name: '金光 弘嗣', password: '0001', department: 'decarbonization', departmentName: '脱炭素事業推進部', role: 'manager', status: 'active', email: 'k.kanemitsu@besterra.co.jp', managerId: null },
            { id: '2149', name: '千綿 太', password: '0001', department: 'hq_office', departmentName: '本社事務所', role: 'user', status: 'active', email: 'f.chiwata@besterra.co.jp', managerId: null },
            { id: '2150', name: '清水 俊樹', password: '0001', department: 'hr_section', departmentName: '人事課', role: 'user', status: 'active', email: 't.shimizu@besterra.co.jp', managerId: null },
            { id: '2152', name: '榎本 卓起', password: '0001', department: 'west_japan_office', departmentName: '西日本事務所', role: 'user', status: 'active', email: 't.enomoto@besterra.co.jp', managerId: null },
            { id: '2153', name: '村野 宏樹', password: '0001', department: 'general_affairs', departmentName: '総務課', role: 'user', status: 'active', email: 'h.murano@besterra.co.jp', managerId: null },
            { id: '2155', name: '小山 悠佑', password: '0001', department: 'construction_planning', departmentName: '工事計画室', role: 'user', status: 'active', email: 'y.koyama@besterra.co.jp', managerId: null },
            { id: '2159', name: '齊藤 将之', password: '0001', department: 'construction_planning', departmentName: '工事計画室', role: 'user', status: 'active', email: 'masayuki.saito@besterra.co.jp', managerId: null },
            { id: '2160', name: '清水 耕平', password: '0001', department: 'keihin_office', departmentName: '京浜事務所', role: 'user', status: 'active', email: 'k.shimizu@besterra.co.jp', managerId: null },
            { id: '2161', name: '桑原 充秀', password: '0001', department: 'west_japan_office', departmentName: '西日本事務所', role: 'user', status: 'active', email: 'm.kuwahara@besterra.co.jp', managerId: null },
            { id: '2162', name: '宮内 秀樹', password: '0001', department: 'management_hq', departmentName: '経営企画本部', role: 'manager', status: 'active', email: 'h.miyauchi@besterra.co.jp', managerId: null },
            { id: '2163', name: '平野 真', password: '0001', department: 'construction_planning', departmentName: '工事計画室', role: 'user', status: 'active', email: 'm.hirano@besterra.co.jp', managerId: null },
            { id: '2166', name: '大𣘺 侑奈', password: '0001', department: 'hr_section', departmentName: '人事課', role: 'user', status: 'active', email: 'y.ohashi@besterra.co.jp', managerId: null },
            { id: '2168', name: '見藤 大希', password: '0001', department: 'chiba_office', departmentName: '千葉事務所', role: 'user', status: 'active', email: 'd.mito@besterra.co.jp', managerId: null },
            { id: '2170', name: '仲嵩 爽由', password: '0001', department: 'keihin_office', departmentName: '京浜事務所', role: 'user', status: 'active', email: 's.nakatake@besterra.co.jp', managerId: null },
            { id: '2171', name: '下屋 奈央', password: '0001', department: 'general_affairs', departmentName: '総務課', role: 'user', status: 'active', email: 'n.shitaya@besterra.co.jp', managerId: null },
            { id: '2173', name: '近藤 尚之', password: '0001', department: 'finance', departmentName: '経理財務課', role: 'user', status: 'active', email: 'n.kondo@besterra.co.jp', managerId: null },
            { id: '2174', name: '宮下 知久', password: '0001', department: 'hq_office', departmentName: '本社事務所', role: 'user', status: 'active', email: 't.miyashita@besterra.co.jp', managerId: null },
            { id: '2175', name: '鬼原 龍太郎', password: '0001', department: 'safety', departmentName: '安全衛生室', role: 'manager', status: 'active', email: 'r.onihara@besterra.co.jp', managerId: null },
            { id: '2176', name: '根本 辰之', password: '0001', department: 'sales', departmentName: '営業部', role: 'manager', status: 'active', email: 't.nemoto@besterra.co.jp', managerId: null },
            { id: '2178', name: '松川 博俊', password: '0001', department: 'west_japan_office', departmentName: '西日本事務所', role: 'user', status: 'active', email: 'h.matsukawa@besterra.co.jp', managerId: null },
            { id: '2180', name: '石川 浩道', password: '0001', department: 'hq_office', departmentName: '本社事務所', role: 'manager', status: 'active', email: 'h.ishikawa@besterra.co.jp', managerId: null },
            { id: '2181', name: '坂本 和夫', password: '0001', department: 'safety', departmentName: '安全衛生室', role: 'manager', status: 'active', email: 'k.sakamoto@besterra.co.jp', managerId: null },
            { id: '2182', name: '黒石 直樹', password: '0001', department: 'west_japan_office', departmentName: '西日本事務所', role: 'user', status: 'active', email: 'n.kuroishi@besterra.co.jp', managerId: null },
            { id: '2183', name: '韓 相牧', password: '0001', department: '3d_measurement', departmentName: '3D計測室', role: 'manager', status: 'active', email: 's.han@besterra.co.jp', managerId: null },
            { id: '2184', name: '瀬古 伸顕', password: '0001', department: 'decarbonization', departmentName: '脱炭素事業推進部', role: 'manager', status: 'active', email: 'n.seko@besterra.co.jp', managerId: null },
            { id: '2187', name: '津野 公寿', password: '0001', department: 'chiba_office', departmentName: '千葉事務所', role: 'manager', status: 'active', email: 't.tsuno@besterra.co.jp', managerId: null },
            { id: '2188', name: '塩田 卓人', password: '0001', department: 'finance', departmentName: '経理財務課', role: 'user', status: 'active', email: 't.shiota@besterra.co.jp', managerId: null },
            { id: '2190', name: '田村 佑介', password: '0001', department: 'chiba_office', departmentName: '千葉事務所', role: 'manager', status: 'active', email: 'y.tamura@besterra.co.jp', managerId: null },
            { id: '2191', name: '竹内 真菜', password: '0001', department: 'engineering', departmentName: '工務部', role: 'user', status: 'active', email: 'm.takeuchi@besterra.co.jp', managerId: null },
            { id: '2192', name: '加藤 千尋', password: '0001', department: 'general_affairs', departmentName: '総務課', role: 'user', status: 'active', email: 'c.kato@besterra.co.jp', managerId: null },
            { id: '2193', name: '菅原 礼衣', password: '0001', department: 'finance', departmentName: '経理財務課', role: 'user', status: 'active', email: 'r.sugawara@besterra.co.jp', managerId: null },
            { id: '2194', name: '館野 麻美', password: '0001', department: 'west_japan_office', departmentName: '西日本事務所', role: 'user', status: 'active', email: 'm.tateno@besterra.co.jp', managerId: null },
            { id: '2195', name: '牛山 美月', password: '0001', department: 'president_office', departmentName: '社長室', role: 'user', status: 'active', email: 'm.ushiyama@besterra.co.jp', managerId: null },
            { id: '2196', name: '大槻 悠貴', password: '0001', department: 'hq_office', departmentName: '本社事務所', role: 'user', status: 'active', email: 'y.otsuki@besterra.co.jp', managerId: null },
            { id: '2197', name: '谷口 竜功', password: '0001', department: 'keihin_office', departmentName: '京浜事務所', role: 'user', status: 'active', email: 'r.taniguchi@besterra.co.jp', managerId: null },
            { id: '2198', name: '中川 貴生', password: '0001', department: 'west_japan_office', departmentName: '西日本事務所', role: 'user', status: 'active', email: 't.nakagawa@besterra.co.jp', managerId: null },
            { id: '2200', name: '赤塚 正昭', password: '0001', department: 'construction_staff', departmentName: '工事部付', role: 'manager', status: 'active', email: 'm.akatsuka@besterra.co.jp', managerId: null },
            { id: '2201', name: '横山 智', password: '0001', department: 'west_japan_office', departmentName: '西日本事務所', role: 'user', status: 'active', email: 's.yokoyama@besterra.co.jp', managerId: null },
            { id: '2203', name: '佐藤 彩香', password: '0001', department: 'hr_section', departmentName: '人事課', role: 'user', status: 'active', email: 'a.sato@besterra.co.jp', managerId: null },
            { id: '2204', name: '長谷部 均', password: '0001', department: 'decarbonization', departmentName: '脱炭素事業推進部', role: 'manager', status: 'active', email: 'h.hasebe@besterra.co.jp', managerId: null },
            { id: '2205', name: '皆川 貴行', password: '0001', department: 'keihin_office', departmentName: '京浜事務所', role: 'user', status: 'active', email: 't.minagawa@besterra.co.jp', managerId: null },
            { id: '2207', name: '渡邉 裕也', password: '0001', department: 'keihin_office', departmentName: '京浜事務所', role: 'manager', status: 'active', email: 'y.watanabe@besterra.co.jp', managerId: null },
            { id: '2208', name: '板庇 明日加', password: '0001', department: 'engineering', departmentName: '工務部', role: 'user', status: 'active', email: 'a.itabisashi@besterra.co.jp', managerId: null },
            { id: '2209', name: '金井 咲樹', password: '0001', department: 'construction_planning', departmentName: '工事計画室', role: 'user', status: 'active', email: 's.kanai@besterra.co.jp', managerId: null },
            { id: '2210', name: '矢田部 剛', password: '0001', department: 'kyushu_office', departmentName: '九州事務所', role: 'user', status: 'active', email: 't.yatabe@besterra.co.jp', managerId: null },
            { id: '2211', name: '坂野 要', password: '0001', department: 'finance', departmentName: '経理財務課', role: 'user', status: 'active', email: 'k.sakano@besterra.co.jp', managerId: null },
            { id: '2212', name: '原 聡汰', password: '0001', department: 'construction_planning', departmentName: '工事計画室', role: 'user', status: 'active', email: 's.hara@besterra.co.jp', managerId: null },
            { id: '2213', name: '藤井 将矢', password: '0001', department: 'hq_office', departmentName: '本社事務所', role: 'user', status: 'active', email: 'm.fujii@besterra.co.jp', managerId: null },
            { id: '2214', name: '増岡 朋哉', password: '0001', department: 'west_japan_office', departmentName: '西日本事務所', role: 'user', status: 'active', email: 't.masuoka@besterra.co.jp', managerId: null },
            { id: '2215', name: '佐々木 政人', password: '0001', department: 'engineering', departmentName: '工務部', role: 'manager', status: 'active', email: 'm.sasaki@besterra.co.jp', managerId: null },
            { id: '2218', name: '佐藤 健太', password: '0001', department: 'chiba_office', departmentName: '千葉事務所', role: 'user', status: 'active', email: 'k.sato@besterra.co.jp', managerId: null },
            { id: '2219', name: '垣内 祥光', password: '0001', department: 'keihin_office', departmentName: '京浜事務所', role: 'user', status: 'active', email: 's.kakiuchi@besterra.co.jp', managerId: null },
            { id: '2220', name: '野村 陽生', password: '0001', department: 'chiba_office', departmentName: '千葉事務所', role: 'user', status: 'active', email: 'h.nomura@besterra.co.jp', managerId: null },
            { id: '2221', name: '松岡 聡', password: '0001', department: 'engineering', departmentName: '工務部', role: 'manager', status: 'active', email: 's.matsuoka@besterra.co.jp', managerId: null },
            { id: '2222', name: '松原 圭一', password: '0001', department: 'west_japan_office', departmentName: '西日本事務所', role: 'user', status: 'active', email: 'k.matsubara@besterra.co.jp', managerId: null },
            { id: '2223', name: '柴田 創', password: '0001', department: 'west_japan_office', departmentName: '西日本事務所', role: 'user', status: 'active', email: 'h.shibata@besterra.co.jp', managerId: null },
            { id: '2224', name: 'レ ミン　トン', password: '0001', department: 'construction_planning', departmentName: '工事計画室', role: 'user', status: 'active', email: 'thong@besterra.co.jp', managerId: null },
            { id: '2225', name: '藤本 清智', password: '0001', department: 'west_japan_office', departmentName: '西日本事務所', role: 'user', status: 'active', email: 'k.fujimoto@besterra.co.jp', managerId: null },
            { id: '2226', name: '鈴木 久仁彦', password: '0001', department: 'keihin_office', departmentName: '京浜事務所', role: 'manager', status: 'active', email: 'kunihiko.suzuki@besterra.co.jp', managerId: null },
            { id: '2227', name: '池上 凜佳', password: '0001', department: 'engineering', departmentName: '工務部', role: 'user', status: 'active', email: 'r.ikegami@besterra.co.jp', managerId: null },
            { id: '2228', name: '中山 孔稀', password: '0001', department: 'hq_office', departmentName: '本社事務所', role: 'user', status: 'active', email: 'k.nakayama@besterra.co.jp', managerId: null },
            { id: '2230', name: '安広 優太', password: '0001', department: 'chiba_office', departmentName: '千葉事務所', role: 'user', status: 'active', email: 'y.yasuhiro@besterra.co.jp', managerId: null },
            { id: '2231', name: '田邉 凌佑', password: '0001', department: 'sales_section', departmentName: '営業課', role: 'user', status: 'active', email: 'r.tanabe@besterra.co.jp', managerId: null },
            { id: '2232', name: '近藤 翼', password: '0001', department: 'chiba_office', departmentName: '千葉事務所', role: 'user', status: 'active', email: 't.kondo@besterra.co.jp', managerId: null },
            { id: '2233', name: '河原 昌一', password: '0001', department: 'chiba_office', departmentName: '千葉事務所', role: 'user', status: 'active', email: 'm.kawahara@besterra.co.jp', managerId: null },
            { id: '2234', name: '森田 玄', password: '0001', department: 'west_japan_office', departmentName: '西日本事務所', role: 'user', status: 'active', email: 'g.morita@besterra.co.jp', managerId: null },
            { id: '2235', name: '西谷 隆', password: '0001', department: 'west_japan_office', departmentName: '西日本事務所', role: 'user', status: 'active', email: 't.nishitani@besterra.co.jp', managerId: null },
            { id: '2236', name: '中川 真未', password: '0001', department: 'west_japan_office', departmentName: '西日本事務所', role: 'user', status: 'active', email: 'm.nakagawa@besterra.co.jp', managerId: null },
            { id: '2237', name: '加藤 美彩希', password: '0001', department: 'chiba_office', departmentName: '千葉事務所', role: 'user', status: 'active', email: 'm.kato@besterra.co.jp', managerId: null },
            { id: '2238', name: '浪川 孝', password: '0001', department: 'chiba_office', departmentName: '千葉事務所', role: 'user', status: 'active', email: 't.namikawa@besterra.co.jp', managerId: null },
            { id: '2239', name: '下青木 唯', password: '0001', department: 'west_japan_office', departmentName: '西日本事務所', role: 'user', status: 'active', email: 'y.shimoaoki@besterra.co.jp', managerId: null },
            { id: '2240', name: '岡村 和馬', password: '0001', department: 'west_japan_office', departmentName: '西日本事務所', role: 'user', status: 'active', email: 'k.okamura@besterra.co.jp', managerId: null },
            { id: '2241', name: '吉岡 涼平', password: '0001', department: 'west_japan_office', departmentName: '西日本事務所', role: 'user', status: 'active', email: 'r.yoshioka@besterra.co.jp', managerId: null },
            { id: '2242', name: '木戸 健太郎', password: '0001', department: 'decarbonization', departmentName: '脱炭素事業推進部', role: 'manager', status: 'active', email: 'k.kido@besterra.co.jp', managerId: null },
            { id: '2243', name: '藤吾 歩', password: '0001', department: 'marketing', departmentName: 'マーケティング部', role: 'manager', status: 'active', email: 'a.togo@besterra.co.jp', managerId: null },
            { id: '4004', name: '草薙 美千代', password: '0001', department: 'chiba_office', departmentName: '千葉事務所', role: 'user', status: 'active', email: 'm.kusanagi@besterra.co.jp', managerId: null },
            { id: '4029', name: '中田 喜代美', password: '0001', department: 'west_japan_office', departmentName: '西日本事務所', role: 'user', status: 'active', email: 'k.nakada@besterra.co.jp', managerId: null },
        ];

                // 部署名マッピング
        const departmentNames = {
            'executive': '代表者',
            'plant_hq': 'プラント事業本部',
            'construction': '工事部',
            'construction_staff': '工事部付',
            'hq_office': '本社事務所',
            'chiba_office': '千葉事務所',
            'jfe_chiba': 'JFE千葉構内作業所',
            'keihin_office': '京浜事務所',
            'west_japan_office': '西日本事務所',
            'kurashiki_office': '倉敷作業所',
            'kyushu_office': '九州事務所',
            'construction_planning': '工事計画室',
            'safety': '安全衛生室',
            'engineering': '工務部',
            'sales': '営業部',
            'sales_section': '営業課',
            'marketing': 'マーケティング部',
            'procurement': '調達室',
            'decarbonization': '脱炭素事業推進部',
            '3d_measurement': '3D計測室',
            'management_hq': '経営企画本部',
            'planning': '企画部',
            'admin_dept': '管理部',
            'general_affairs': '総務課',
            'finance': '経理財務課',
            'hr': '人事部',
            'hr_section': '人事課',
            'president_office': '社長室',
            'none': '所属部署なし'
        };

        // プロジェクトデータ
        let projects = [
            {
                id: 1,
                category: 'company',
                title: 'DX推進プロジェクト',
                description: '社内業務のデジタル化を推進し、生産性向上を目指すプロジェクトです。各部署の業務フローの見直しから、新システムの導入まで幅広く活動します。',
                image: '🏗️',
                capacity: { current: 8, max: 12 },
                status: 'recruiting',
                leader: '山田太郎',
                department: 'DX推進部',
                startDate: '2024/01/01',
                endDate: '2024/12/31',
                skills: ['プロジェクト管理', 'システム設計', 'データ分析'],
                members: [
                    { name: '山田太郎', role: 'リーダー' },
                    { name: '佐藤花子', role: 'サブリーダー' },
                    { name: '鈴木一郎', role: 'メンバー' },
                ],
                progress: [
                    { task: '要件定義', status: '完了' },
                    { task: '設計フェーズ', status: '進行中' },
                    { task: '開発フェーズ', status: '未着手' },
                ],
                comments: [
                    { author: '山田太郎', text: '来週からシステム設計のレビューを開始します。参加希望の方はお知らせください。', date: '2024/01/15' },
                    { author: '佐藤花子', text: '業務フローの整理が完了しました。資料をSharePointにアップロードしています。', date: '2024/01/12' },
                ]
            },
            {
                id: 2,
                category: 'company',
                title: '新規事業開発チーム',
                description: '新たなビジネス機会の探索と事業化を目指すチームです。市場調査から事業計画策定まで、一連のプロセスを経験できます。',
                image: '🌱',
                capacity: { current: 5, max: 8 },
                status: 'recruiting',
                leader: '田中次郎',
                department: '企画本部',
                startDate: '2024/02/01',
                endDate: '2025/03/31',
                skills: ['事業企画', '市場分析', 'プレゼンテーション'],
                members: [
                    { name: '田中次郎', role: 'リーダー' },
                    { name: '高橋美咲', role: 'メンバー' },
                ],
                progress: [
                    { task: '市場調査', status: '進行中' },
                    { task: '事業計画策定', status: '未着手' },
                ],
                comments: [
                    { author: '田中次郎', text: '来月から本格的に市場調査を開始します。興味のある方は是非！', date: '2024/01/10' },
                ]
            },
            {
                id: 3,
                category: 'company',
                title: 'AI活用推進チーム',
                description: '生成AIを活用した業務効率化を推進するチームです。ChatGPTやClaude等の活用事例を社内に展開します。',
                image: '🤖',
                capacity: { current: 6, max: 6 },
                status: 'ongoing',
                leader: '伊藤健',
                department: 'DX推進部',
                startDate: '2023/10/01',
                endDate: '2024/09/30',
                skills: ['AI/ML', 'プロンプトエンジニアリング', '業務改善'],
                members: [
                    { name: '伊藤健', role: 'リーダー' },
                    { name: '渡辺明', role: 'テックリード' },
                ],
                progress: [
                    { task: 'ガイドライン策定', status: '完了' },
                    { task: '社内展開', status: '進行中' },
                ],
                comments: []
            },
            {
                id: 4,
                category: 'company',
                title: 'サステナビリティ推進',
                description: '環境負荷低減と持続可能な事業活動を推進するプロジェクト。カーボンニュートラルへの取り組みを主導します。',
                image: '🌍',
                capacity: { current: 4, max: 10 },
                status: 'recruiting',
                leader: '木村さくら',
                department: '管理本部',
                startDate: '2024/01/01',
                endDate: '2025/12/31',
                skills: ['環境管理', 'データ収集', '報告書作成'],
                members: [
                    { name: '木村さくら', role: 'リーダー' },
                ],
                progress: [
                    { task: '現状分析', status: '進行中' },
                    { task: '目標設定', status: '未着手' },
                ],
                comments: []
            },
            {
                id: 5,
                category: 'department',
                title: '業務効率化チーム',
                description: '部署内の業務プロセスを見直し、効率化を図るチームです。RPA導入やマニュアル整備を進めています。',
                image: '📊',
                capacity: { current: 5, max: 7 },
                status: 'ongoing',
                leader: '中村雄太',
                department: 'エンジニアリング事業部',
                startDate: '2023/10/01',
                endDate: '2024/06/30',
                skills: ['業務分析', 'RPA', 'ドキュメント作成'],
                members: [
                    { name: '中村雄太', role: 'リーダー' },
                    { name: '小林優子', role: 'メンバー' },
                ],
                progress: [
                    { task: '業務棚卸し', status: '完了' },
                    { task: 'RPA開発', status: '進行中' },
                    { task: 'マニュアル作成', status: '未着手' },
                ],
                comments: []
            },
            {
                id: 6,
                category: 'department',
                title: '若手育成プログラム',
                description: '新入社員・若手社員の育成を目的としたメンタリングプログラムです。先輩社員がメンターとして参加します。',
                image: '📚',
                capacity: { current: 8, max: 15 },
                status: 'recruiting',
                leader: '吉田恵',
                department: '管理本部',
                startDate: '2024/04/01',
                endDate: '2025/03/31',
                skills: ['コーチング', 'コミュニケーション', '指導経験'],
                members: [],
                progress: [],
                comments: []
            },
            {
                id: 7,
                category: 'department',
                title: '安全管理向上チーム',
                description: '現場の安全管理体制の強化と事故防止を目的としたチームです。安全教育の企画・実施を行います。',
                image: '⚠️',
                capacity: { current: 6, max: 8 },
                status: 'ongoing',
                leader: '松本剛',
                department: 'エンジニアリング事業部',
                startDate: '2023/07/01',
                endDate: '2024/06/30',
                skills: ['安全管理', '教育企画', 'リスクアセスメント'],
                members: [],
                progress: [],
                comments: []
            },
            {
                id: 8,
                category: 'department',
                title: '顧客満足度向上PJ',
                description: '顧客アンケートの分析と改善施策の立案・実行を行うプロジェクトです。',
                image: '⭐',
                capacity: { current: 3, max: 6 },
                status: 'recruiting',
                leader: '井上真理',
                department: '営業本部',
                startDate: '2024/01/01',
                endDate: '2024/12/31',
                skills: ['データ分析', '顧客対応', '企画立案'],
                members: [],
                progress: [],
                comments: []
            },
            {
                id: 9,
                category: 'other',
                title: 'フットサル部',
                description: '週末に集まってフットサルを楽しむ部活動です。初心者大歓迎！運動不足解消にぜひ参加してください。',
                image: '⚽',
                capacity: { current: 15, max: 20 },
                status: 'recruiting',
                leader: '斎藤翔',
                department: '全社',
                startDate: '通年',
                endDate: '-',
                skills: [],
                members: [],
                progress: [],
                comments: [
                    { author: '斎藤翔', text: '今週土曜日、14時から○○体育館で練習します！', date: '2024/01/14' },
                ]
            },
            {
                id: 10,
                category: 'other',
                title: 'ランニング部',
                description: '朝活ランニングやマラソン大会への参加を行う部活動です。一緒に走りましょう！',
                image: '🏃',
                capacity: { current: 10, max: 30 },
                status: 'recruiting',
                leader: '加藤美穂',
                department: '全社',
                startDate: '通年',
                endDate: '-',
                skills: [],
                members: [],
                progress: [],
                comments: []
            },
            {
                id: 11,
                category: 'other',
                title: '写真部',
                description: '写真撮影を趣味とするメンバーが集まる部活動です。撮影会や作品発表会を開催しています。',
                image: '📷',
                capacity: { current: 8, max: 15 },
                status: 'recruiting',
                leader: '山口健二',
                department: '全社',
                startDate: '通年',
                endDate: '-',
                skills: [],
                members: [],
                progress: [],
                comments: []
            },
            {
                id: 12,
                category: 'other',
                title: 'ボランティア活動',
                description: '地域清掃やチャリティイベントへの参加を行うボランティア活動グループです。',
                image: '🤝',
                capacity: { current: 12, max: 25 },
                status: 'recruiting',
                leader: '清水由美',
                department: '全社',
                startDate: '通年',
                endDate: '-',
                skills: [],
                members: [],
                progress: [],
                comments: []
            },
        ];

        // 参加申請データ
        let applications = [
            { id: 1, applicant: 'テストユーザ', applicantId: '1001', projectId: 2, projectTitle: '新規事業開発チーム', date: '2024/01/15', status: 'pending' },
            { id: 2, applicant: '山田太郎', applicantId: '1002', projectId: 1, projectTitle: 'DX推進プロジェクト', date: '2024/01/14', status: 'pending' },
            { id: 3, applicant: '佐藤花子', applicantId: '1003', projectId: 4, projectTitle: 'サステナビリティ推進', date: '2024/01/13', status: 'pending' },
            { id: 4, applicant: '鈴木一郎', applicantId: '1004', projectId: 1, projectTitle: 'DX推進プロジェクト', date: '2024/01/10', status: 'approved' },
        ];

        // プロジェクト申請ワークフローデータ
        let projectProposals = [
            {
                id: 1,
                title: 'テスト企画プロジェクト',
                category: 'company',
                description: 'テスト用のプロジェクト企画です。',
                icon: '🧪',
                capacity: 5,
                leader: 'テストユーザ',
                department: 'DX推進部',
                startDate: '2024/02/01',
                endDate: '2024/12/31',
                skills: ['企画', 'テスト'],
                submittedBy: '1001',
                submitterName: 'テストユーザ',
                submitterEmail: 'test@besterra.co.jp',
                workflowStatus: 'pending_manager', // draft, pending_manager, pending_admin, approved, rejected
                workflowHistory: [
                    { action: 'submit', by: 'テストユーザ', date: '2024/01/15 10:00', comment: '企画を提出しました' }
                ],
                managerId: '1006',
                managerName: '高橋部長',
                managerEmail: 'takahashi@besterra.co.jp',
                createdAt: '2024/01/15'
            }
        ];

        // 通知データ
        let notifications = [
            { id: 1, icon: '✅', title: '参加申請が承認されました', detail: 'DX推進プロジェクト • 2024/01/10' },
            { id: 2, icon: '💬', title: '新しいコメントがあります', detail: '業務効率化チーム • 2024/01/09' },
            { id: 3, icon: '📢', title: '新規プロジェクトの募集開始', detail: 'AI活用推進チーム • 2024/01/08' },
        ];

        // 現在のユーザー情報
        let currentUser = null;
        let isAdmin = false;
        let currentTab = 'company';
        let currentAdminPanel = 'projects';
        let selectedProject = null;
        let deleteTargetId = null;
        let deleteTargetType = null;

        // 統一ログイン処理
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const inputId = document.getElementById('userId').value;
            const password = document.getElementById('userPassword').value;

            // 管理者ログイン判定
            if (inputId === ADMIN_CREDENTIALS.id && password === ADMIN_CREDENTIALS.password) {
                currentUser = {
                    id: 'admin',
                    name: '管理者',
                    avatar: '管'
                };
                isAdmin = true;

                document.getElementById('loginOverlay').classList.add('hidden');
                document.getElementById('adminApp').style.display = 'block';
                document.getElementById('loginError').classList.remove('show');

                renderAdminProjects();
                renderApplications();
                renderUsers();
                updateAdminStats();
                return;
            }

            // 社員ログイン処理
            let user = null;

            // Supabaseから直接認証
            if (useDatabase) {
                try {
                    const { data, error } = await supabaseClient
                        .from('users')
                        .select('*')
                        .eq('id', inputId)
                        .eq('password', password)
                        .eq('status', 'active')
                        .single();
                    if (!error && data) {
                        user = {
                            id: data.id,
                            name: data.name,
                            password: data.password,
                            department: data.department,
                            departmentName: data.department_name,
                            role: data.role,
                            status: data.status,
                            email: data.email,
                            managerId: data.manager_id
                        };
                    }
                } catch (err) {
                    console.error('Login error:', err);
                }
            } else {
                // ローカルデータで認証
                user = users.find(u => u.id === inputId && u.password === password && u.status === 'active');
            }

            if (user) {
                const manager = users.find(u => u.id === user.managerId);
                currentUser = {
                    id: user.id,
                    name: user.name,
                    department: user.department,
                    departmentName: user.departmentName,
                    role: user.role,
                    email: user.email,
                    managerId: user.managerId,
                    managerName: manager ? manager.name : null,
                    managerEmail: manager ? manager.email : null,
                    avatar: user.name.charAt(0)
                };
                isAdmin = false;

                document.getElementById('loginOverlay').classList.add('hidden');
                document.getElementById('userApp').style.display = 'block';
                document.getElementById('userAvatar').textContent = currentUser.avatar;
                document.getElementById('userNameDisplay').textContent = currentUser.name;
                document.getElementById('loginError').classList.remove('show');

                // 上長の場合はナビを表示
                if (currentUser.role === 'manager') {
                    document.getElementById('managerNavItem').style.display = 'flex';
                    renderManagerApprovals();
                }

                // PJ承認者として指定されている場合もナビを表示
                const hasPendingApprovals = projectProposals.some(p =>
                    p.approverId === currentUser.id && p.workflowStatus === 'pending_approver'
                );
                if (hasPendingApprovals) {
                    document.getElementById('approverNavItem').style.display = 'flex';
                }
                renderApproverApprovals();

                // 部署名を表示
                document.getElementById('userDeptDisplay').textContent = currentUser.departmentName;

                renderProjects();
                renderMyPage();
                renderMyProposals();
                renderNotifications();
                updateStats();
            } else {
                document.getElementById('loginError').classList.add('show');
            }
        });

        // 管理者パネル切り替え
        function switchAdminPanel(panel) {
            currentAdminPanel = panel;
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.admin-panel').forEach(p => p.classList.remove('active'));

            document.querySelector(`.admin-tab:nth-child(${panel === 'projects' ? 1 : panel === 'applications' ? 2 : 3})`).classList.add('active');
            document.getElementById(`${panel}Panel`).classList.add('active');
        }

        // タブ切り替え
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab, .filter-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll(`[data-tab="${tab}"]`).forEach(t => t.classList.add('active'));
            renderProjects();
        }

        // プロジェクト一覧の表示（Indeed風コンパクトカード）
        function renderProjects() {
            const container = document.getElementById('projectList');
            const searchQuery = document.getElementById('searchInput').value.toLowerCase();

            const filteredProjects = projects.filter(p => {
                const matchesTab = p.category === currentTab;
                const matchesSearch = p.title.toLowerCase().includes(searchQuery) ||
                                     p.description.toLowerCase().includes(searchQuery);
                return matchesTab && matchesSearch;
            });

            container.innerHTML = filteredProjects.map(project => {
                const capacityPercent = (project.capacity.current / project.capacity.max) * 100;

                let categoryClass = '';
                let categoryLabel = '';
                if (project.category === 'company') {
                    categoryClass = 'category-company';
                    categoryLabel = '全社';
                } else if (project.category === 'department') {
                    categoryClass = 'category-department';
                    categoryLabel = '部署';
                } else {
                    categoryClass = 'category-other';
                    categoryLabel = '社員活動';
                }

                let statusClass = '';
                let statusLabel = '';
                if (project.status === 'recruiting') {
                    statusClass = 'status-recruiting';
                    statusLabel = '募集中';
                } else if (project.status === 'ongoing') {
                    statusClass = 'status-ongoing';
                    statusLabel = '進行中';
                } else {
                    statusClass = 'status-closed';
                    statusLabel = '終了';
                }

                const isSelected = selectedProject && selectedProject.id === project.id;

                return `
                    <div class="project-card-compact ${isSelected ? 'selected' : ''}" onclick="showProjectInPanel(${project.id})" data-project-id="${project.id}">
                        <div class="card-header">
                            <h3 class="project-title">${project.title}</h3>
                            <span class="project-category ${categoryClass}">${categoryLabel}</span>
                        </div>
                        <p class="project-description">${project.description}</p>
                        <div class="card-footer">
                            <div class="card-meta">
                                <span class="meta-item">👥 ${project.capacity.current}/${project.capacity.max}人</span>
                                <span class="meta-item">📅 ${project.endDate}</span>
                            </div>
                            <span class="project-status ${statusClass}">${statusLabel}</span>
                        </div>
                    </div>
                `;
            }).join('');

            // プロジェクトが存在し、何も選択されていない場合は最初のプロジェクトを自動選択
            if (filteredProjects.length > 0 && !selectedProject) {
                showProjectInPanel(filteredProjects[0].id);
            }
        }

        // 詳細パネルをリセット
        function resetDetailPanel() {
            selectedProject = null;
            document.getElementById('detailPanelEmpty').style.display = 'flex';
            document.getElementById('detailPanelContent').style.display = 'none';
            document.querySelectorAll('.project-card-compact').forEach(card => {
                card.classList.remove('selected');
            });
        }

        // プロジェクト詳細をパネルに表示（Indeed風）
        function showProjectInPanel(projectId) {
            selectedProject = projects.find(p => p.id === projectId);
            if (!selectedProject) return;

            // カードの選択状態を更新
            document.querySelectorAll('.project-card-compact').forEach(card => {
                card.classList.remove('selected');
            });
            const selectedCard = document.querySelector(`[data-project-id="${projectId}"]`);
            if (selectedCard) {
                selectedCard.classList.add('selected');
            }

            const capacityPercent = (selectedProject.capacity.current / selectedProject.capacity.max) * 100;
            const isJoinable = selectedProject.status === 'recruiting' && capacityPercent < 100;

            let categoryClass = '';
            let categoryLabel = '';
            if (selectedProject.category === 'company') {
                categoryClass = 'category-company';
                categoryLabel = '全社プロジェクト';
            } else if (selectedProject.category === 'department') {
                categoryClass = 'category-department';
                categoryLabel = '部署プロジェクト';
            } else {
                categoryClass = 'category-other';
                categoryLabel = '社員活動';
            }

            let statusClass = '';
            let statusLabel = '';
            if (selectedProject.status === 'recruiting') {
                statusClass = 'status-recruiting';
                statusLabel = '募集中';
            } else if (selectedProject.status === 'ongoing') {
                statusClass = 'status-ongoing';
                statusLabel = '進行中';
            } else {
                statusClass = 'status-closed';
                statusLabel = '終了';
            }

            // 空表示を非表示、コンテンツを表示
            document.getElementById('detailPanelEmpty').style.display = 'none';
            const contentPanel = document.getElementById('detailPanelContent');
            contentPanel.style.display = 'block';

            // ボタンテキストの決定
            let buttonHtml = '';
            if (isJoinable) {
                buttonHtml = `<button class="btn btn-primary" onclick="openApplyModal()">参加を申請する</button>`;
            } else if (capacityPercent >= 100) {
                buttonHtml = `<button class="btn btn-outline" disabled>定員に達しています</button>`;
            } else {
                buttonHtml = `<button class="btn btn-outline" disabled>募集終了</button>`;
            }

            contentPanel.innerHTML = `
                <div class="detail-panel-header">
                    <div class="header-top">
                        <h2 class="project-title">${selectedProject.title}</h2>
                        <span class="project-category ${categoryClass}">${categoryLabel}</span>
                    </div>
                    <div class="project-meta">
                        <span class="meta-item">👤 ${selectedProject.leader}</span>
                        <span class="meta-item">🏢 ${selectedProject.department}</span>
                        <span class="meta-item project-status ${statusClass}">${statusLabel}</span>
                    </div>
                </div>
                <div class="detail-panel-body">
                    <div class="info-grid">
                        <div class="info-item">
                            <label>期間</label>
                            <div class="value">${selectedProject.startDate} 〜 ${selectedProject.endDate}</div>
                        </div>
                        <div class="info-item">
                            <label>定員</label>
                            <div class="value">${selectedProject.capacity.current} / ${selectedProject.capacity.max}人</div>
                        </div>
                    </div>

                    <h4 class="detail-section-title">概要</h4>
                    <p class="description-text">${selectedProject.description}</p>

                    ${selectedProject.skills.length > 0 ? `
                    <h4 class="detail-section-title">求めるスキル・経験</h4>
                    <div class="skill-tags">
                        ${selectedProject.skills.map(skill => `<span class="skill-tag">${skill}</span>`).join('')}
                    </div>
                    ` : ''}

                    ${selectedProject.members.length > 0 ? `
                    <h4 class="detail-section-title">メンバー</h4>
                    <div class="members-grid">
                        ${selectedProject.members.map(m => `
                            <div class="member-card">
                                <div class="member-avatar">${m.name.charAt(0)}</div>
                                <div class="member-info">
                                    <div class="member-name">${m.name}</div>
                                    <div class="member-role">${m.role}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}

                    ${selectedProject.progress.length > 0 ? `
                    <h4 class="detail-section-title">進捗状況</h4>
                    <div class="progress-section" style="margin-bottom: 24px;">
                        ${selectedProject.progress.map(p => `
                            <div class="progress-item">
                                <span>${p.task}</span>
                                <strong>${p.status}</strong>
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}

                    ${selectedProject.comments.length > 0 ? `
                    <h4 class="detail-section-title">コメント・更新情報</h4>
                    <div class="comment-section">
                        ${selectedProject.comments.map(c => `
                            <div class="comment-item">
                                <span class="member-avatar">${c.author.charAt(0)}</span>
                                <div class="comment-content">
                                    <div class="comment-author">${c.author}</div>
                                    <div class="comment-text">${c.text}</div>
                                    <div class="comment-date">${c.date}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}
                </div>
                <div class="detail-panel-footer">
                    ${buttonHtml}
                </div>
            `;
        }

        // 申請モーダルを開く
        function openApplyModal() {
            if (!selectedProject) return;
            document.getElementById('modalTitle').textContent = selectedProject.title + ' への参加申請';
            document.getElementById('modalBody').innerHTML = `
                <div class="form-group">
                    <label>志望理由・アピールポイント</label>
                    <textarea id="applyReason" placeholder="このプロジェクトに参加したい理由を入力してください"></textarea>
                </div>
            `;
            document.getElementById('applyBtn').style.display = 'block';
            document.getElementById('applyBtn').textContent = '申請を送信';
            document.getElementById('applyBtn').disabled = false;
            document.getElementById('modalOverlay').classList.add('show');
        }

        // プロジェクト詳細を開く
        function openProjectDetail(projectId) {
            selectedProject = projects.find(p => p.id === projectId);
            if (!selectedProject) return;

            document.getElementById('modalTitle').textContent = selectedProject.title;

            const capacityPercent = (selectedProject.capacity.current / selectedProject.capacity.max) * 100;
            const isJoinable = selectedProject.status === 'recruiting' && capacityPercent < 100;

            document.getElementById('modalBody').innerHTML = `
                <div class="detail-image">${selectedProject.image}</div>

                <div class="detail-section">
                    <h3>概要</h3>
                    <p>${selectedProject.description}</p>
                </div>

                <div class="detail-section">
                    <h3>基本情報</h3>
                    <div class="progress-section">
                        <div class="progress-item">
                            <span>リーダー</span>
                            <strong>${selectedProject.leader}</strong>
                        </div>
                        <div class="progress-item">
                            <span>担当部署</span>
                            <strong>${selectedProject.department}</strong>
                        </div>
                        <div class="progress-item">
                            <span>期間</span>
                            <strong>${selectedProject.startDate} 〜 ${selectedProject.endDate}</strong>
                        </div>
                        <div class="progress-item">
                            <span>定員</span>
                            <strong>${selectedProject.capacity.current} / ${selectedProject.capacity.max}人</strong>
                        </div>
                    </div>
                </div>

                ${selectedProject.skills.length > 0 ? `
                <div class="detail-section">
                    <h3>求めるスキル・経験</h3>
                    <div class="member-list">
                        ${selectedProject.skills.map(skill => `<span class="member-badge">${skill}</span>`).join('')}
                    </div>
                </div>
                ` : ''}

                ${selectedProject.members.length > 0 ? `
                <div class="detail-section">
                    <h3>メンバー</h3>
                    <div class="member-list">
                        ${selectedProject.members.map(m => `
                            <span class="member-badge">
                                <span class="member-avatar">${m.name.charAt(0)}</span>
                                ${m.name}（${m.role}）
                            </span>
                        `).join('')}
                    </div>
                </div>
                ` : ''}

                ${selectedProject.progress.length > 0 ? `
                <div class="detail-section">
                    <h3>進捗状況</h3>
                    <div class="progress-section">
                        ${selectedProject.progress.map(p => `
                            <div class="progress-item">
                                <span>${p.task}</span>
                                <strong>${p.status}</strong>
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}

                ${selectedProject.comments.length > 0 ? `
                <div class="detail-section">
                    <h3>コメント・更新情報</h3>
                    <div class="comment-section">
                        ${selectedProject.comments.map(c => `
                            <div class="comment-item">
                                <span class="member-avatar">${c.author.charAt(0)}</span>
                                <div class="comment-content">
                                    <div class="comment-author">${c.author}</div>
                                    <div class="comment-text">${c.text}</div>
                                    <div class="comment-date">${c.date}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}
            `;

            const applyBtn = document.getElementById('applyBtn');
            if (isJoinable) {
                applyBtn.style.display = 'block';
                applyBtn.textContent = '参加申請';
                applyBtn.disabled = false;
            } else if (capacityPercent >= 100) {
                applyBtn.style.display = 'block';
                applyBtn.textContent = '定員に達しています';
                applyBtn.disabled = true;
            } else {
                applyBtn.style.display = 'none';
            }

            document.getElementById('modalOverlay').classList.add('show');
        }

        // モーダルを閉じる
        function closeModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('modalOverlay').classList.remove('show');
            const applyBtn = document.getElementById('applyBtn');
            applyBtn.disabled = false;
        }

        // 参加申請
        function applyProject() {
            if (!selectedProject || !currentUser) return;

            const newApplication = {
                id: applications.length + 1,
                applicant: currentUser.name,
                applicantId: currentUser.id,
                projectId: selectedProject.id,
                projectTitle: selectedProject.title,
                date: new Date().toLocaleDateString('ja-JP'),
                status: 'pending'
            };
            applications.push(newApplication);

            document.getElementById('modalOverlay').classList.remove('show');
            document.getElementById('successTitle').textContent = '申請完了';
            document.getElementById('successMessage').innerHTML = '参加申請を送信しました。<br>承認までしばらくお待ちください。';
            document.getElementById('successOverlay').style.display = 'flex';

            renderMyPage();
        }

        // 申請完了モーダルを閉じる
        function closeSuccessModal() {
            document.getElementById('successOverlay').style.display = 'none';
        }

        // ページ切り替え
        function showPage(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

            if (page === 'home') {
                document.getElementById('homePage').classList.add('active');
                document.querySelectorAll('.nav-item')[0].classList.add('active');
                // 詳細パネルをリセット
                resetDetailPanel();
                renderProjects();
            } else if (page === 'my') {
                document.getElementById('myPage').classList.add('active');
                document.querySelectorAll('.nav-item')[1].classList.add('active');
                renderMyPage();
            } else if (page === 'manager') {
                document.getElementById('managerPage').classList.add('active');
                document.getElementById('managerNavItem').classList.add('active');
                renderManagerApprovals();
            } else if (page === 'approver') {
                document.getElementById('approverPage').classList.add('active');
                document.getElementById('approverNavItem').classList.add('active');
                renderApproverApprovals();
            } else if (page === 'notification') {
                document.getElementById('notificationPage').classList.add('active');
                // 通知アイコンのインデックスは動的なのでIDで取得
                const notificationNav = document.querySelector('.notification-badge');
                if (notificationNav) notificationNav.classList.add('active');
            }
        }

        // マイページ表示
        function renderMyPage() {
            const myProjects = [
                { icon: '🏗️', title: 'DX推進プロジェクト', role: 'メンバー • 2024/01〜' },
                { icon: '📊', title: '業務効率化チーム', role: 'リーダー • 2023/10〜' },
                { icon: '⚽', title: 'フットサル部', role: 'メンバー • 2023/06〜' },
            ];

            document.getElementById('myProjectsList').innerHTML = myProjects.map(p => `
                <div class="my-project-item">
                    <div class="my-project-icon">${p.icon}</div>
                    <div class="my-project-info">
                        <div class="my-project-title">${p.title}</div>
                        <div class="my-project-role">${p.role}</div>
                    </div>
                </div>
            `).join('');

            const myApplications = applications.filter(a => a.applicantId === currentUser?.id && a.status === 'pending');
            document.getElementById('pendingCount').textContent = myApplications.length;

            document.getElementById('myApplicationsList').innerHTML = myApplications.length > 0 ? myApplications.map(a => `
                <div class="my-project-item">
                    <div class="my-project-icon">📝</div>
                    <div class="my-project-info">
                        <div class="my-project-title">${a.projectTitle}</div>
                        <div class="my-project-role">審査中 • 申請日: ${a.date}</div>
                    </div>
                </div>
            `).join('') : '<p style="color: var(--text-secondary);">申請中のプロジェクトはありません</p>';
        }

        // 通知表示
        function renderNotifications() {
            document.getElementById('notificationList').innerHTML = notifications.map(n => `
                <div class="my-project-item">
                    <div class="my-project-icon">${n.icon}</div>
                    <div class="my-project-info">
                        <div class="my-project-title">${n.title}</div>
                        <div class="my-project-role">${n.detail}</div>
                    </div>
                </div>
            `).join('');
        }

        // 統計更新
        function updateStats() {
            document.getElementById('totalProjects').textContent = projects.length;
            document.getElementById('recruiting').textContent = projects.filter(p => p.status === 'recruiting').length;
        }

        // ログアウト
        function logout() {
            currentUser = null;
            isAdmin = false;
            document.getElementById('userApp').style.display = 'none';
            document.getElementById('adminApp').style.display = 'none';
            document.getElementById('loginOverlay').classList.remove('hidden');
            document.getElementById('userDropdown').classList.remove('show');
            document.getElementById('adminDropdown').classList.remove('show');

            document.getElementById('userLoginForm').reset();
            document.getElementById('adminLoginForm').reset();
            document.getElementById('userError').classList.remove('show');
            document.getElementById('adminError').classList.remove('show');
        }

        // ユーザードロップダウン
        document.getElementById('userAvatar').addEventListener('click', function() {
            document.getElementById('userDropdown').classList.toggle('show');
        });

        document.getElementById('adminAvatar').addEventListener('click', function() {
            document.getElementById('adminDropdown').classList.toggle('show');
        });

        // 検索機能
        document.getElementById('searchInput').addEventListener('input', renderProjects);

        // 外側クリックでドロップダウンを閉じる
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.user-dropdown')) {
                document.getElementById('userDropdown').classList.remove('show');
                document.getElementById('adminDropdown').classList.remove('show');
            }
        });

        // ======= 管理者機能 =======

        // 管理者プロジェクト一覧表示
        function renderAdminProjects() {
            const tbody = document.getElementById('adminProjectList');
            tbody.innerHTML = projects.map(project => {
                let categoryLabel = '';
                if (project.category === 'company') categoryLabel = '全社';
                else if (project.category === 'department') categoryLabel = '部署';
                else categoryLabel = 'その他';

                let statusLabel = '';
                let statusClass = '';
                if (project.status === 'recruiting') {
                    statusLabel = '募集中';
                    statusClass = 'status-recruiting';
                } else if (project.status === 'ongoing') {
                    statusLabel = '進行中';
                    statusClass = 'status-ongoing';
                } else {
                    statusLabel = '終了';
                    statusClass = 'status-closed';
                }

                return `
                    <tr>
                        <td><strong>${project.image} ${project.title}</strong></td>
                        <td>${categoryLabel}</td>
                        <td>${project.capacity.current}/${project.capacity.max}</td>
                        <td><span class="project-status ${statusClass}">${statusLabel}</span></td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-outline" onclick="editProject(${project.id})">編集</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteProject(${project.id})">削除</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // 申請一覧表示
        function renderApplications() {
            const tbody = document.getElementById('applicationList');
            tbody.innerHTML = applications.map(app => {
                let statusLabel = '';
                let statusClass = '';
                if (app.status === 'pending') {
                    statusLabel = '審査中';
                    statusClass = 'application-pending';
                } else if (app.status === 'approved') {
                    statusLabel = '承認済';
                    statusClass = 'application-approved';
                } else {
                    statusLabel = '却下';
                    statusClass = 'application-rejected';
                }

                const actionButtons = app.status === 'pending' ? `
                    <div class="action-buttons">
                        <button class="btn btn-sm btn-success" onclick="approveApplication(${app.id})">承認</button>
                        <button class="btn btn-sm btn-danger" onclick="rejectApplication(${app.id})">却下</button>
                    </div>
                ` : '-';

                return `
                    <tr>
                        <td>${app.applicant} (${app.applicantId})</td>
                        <td>${app.projectTitle}</td>
                        <td>${app.date}</td>
                        <td><span class="application-status ${statusClass}">${statusLabel}</span></td>
                        <td>${actionButtons}</td>
                    </tr>
                `;
            }).join('');
        }

        // ユーザー一覧表示
        function renderUsers() {
            const tbody = document.getElementById('userList');
            tbody.innerHTML = users.map(user => {
                let roleClass = 'role-user';
                let roleLabel = '一般';
                if (user.role === 'admin') {
                    roleClass = 'role-admin';
                    roleLabel = '管理者';
                } else if (user.role === 'manager') {
                    roleClass = 'role-manager';
                    roleLabel = '上長';
                }
                const statusClass = user.status === 'active' ? 'user-status-active' : 'user-status-inactive';
                const statusLabel = user.status === 'active' ? '有効' : '無効';
                const manager = users.find(u => u.id === user.managerId);
                const managerInfo = manager ? `<br><small style="color: var(--text-secondary);">上長: ${manager.name}</small>` : '';

                return `
                    <tr>
                        <td><strong>${user.id}</strong></td>
                        <td>${user.name}${managerInfo}</td>
                        <td>${user.departmentName}</td>
                        <td><span class="user-role ${roleClass}">${roleLabel}</span></td>
                        <td><span class="application-status ${statusClass}">${statusLabel}</span></td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-outline" onclick="editUser('${user.id}')">編集</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteUser('${user.id}')">削除</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // 管理者統計更新
        function updateAdminStats() {
            document.getElementById('adminTotalProjects').textContent = projects.length;
            document.getElementById('adminTotalUsers').textContent = users.length;
            document.getElementById('adminPendingApplications').textContent = applications.filter(a => a.status === 'pending').length;
            document.getElementById('adminTotalMembers').textContent = projects.reduce((sum, p) => sum + p.capacity.current, 0);
        }

        // プロジェクト作成フォームを開く
        function openProjectForm() {
            document.getElementById('projectFormTitle').textContent = '新規プロジェクト作成';
            document.getElementById('projectForm').reset();
            document.getElementById('projectId').value = '';
            document.getElementById('projectFormModal').classList.add('show');
        }

        // プロジェクト編集
        function editProject(id) {
            const project = projects.find(p => p.id === id);
            if (!project) return;

            document.getElementById('projectFormTitle').textContent = 'プロジェクト編集';
            document.getElementById('projectId').value = project.id;
            document.getElementById('projectTitle').value = project.title;
            document.getElementById('projectCategory').value = project.category;
            document.getElementById('projectDescription').value = project.description;
            document.getElementById('projectIcon').value = project.image;
            document.getElementById('projectCapacity').value = project.capacity.max;
            document.getElementById('projectLeader').value = project.leader;
            document.getElementById('projectDepartment').value = project.department;
            document.getElementById('projectStartDate').value = project.startDate;
            document.getElementById('projectEndDate').value = project.endDate;
            document.getElementById('projectStatus').value = project.status;
            document.getElementById('projectSkills').value = project.skills.join(', ');

            document.getElementById('projectFormModal').classList.add('show');
        }

        // プロジェクトフォームを閉じる
        function closeProjectForm() {
            document.getElementById('projectFormModal').classList.remove('show');
        }

        // プロジェクト保存
        function saveProject() {
            const id = document.getElementById('projectId').value;
            const title = document.getElementById('projectTitle').value;
            const category = document.getElementById('projectCategory').value;
            const description = document.getElementById('projectDescription').value;
            const icon = document.getElementById('projectIcon').value || '📋';
            const capacity = parseInt(document.getElementById('projectCapacity').value);
            const leader = document.getElementById('projectLeader').value;
            const department = document.getElementById('projectDepartment').value;
            const startDate = document.getElementById('projectStartDate').value;
            const endDate = document.getElementById('projectEndDate').value;
            const status = document.getElementById('projectStatus').value;
            const skills = document.getElementById('projectSkills').value.split(',').map(s => s.trim()).filter(s => s);

            if (!title || !description || !capacity || !leader || !department) {
                alert('必須項目を入力してください');
                return;
            }

            if (id) {
                const project = projects.find(p => p.id === parseInt(id));
                if (project) {
                    project.title = title;
                    project.category = category;
                    project.description = description;
                    project.image = icon;
                    project.capacity.max = capacity;
                    project.leader = leader;
                    project.department = department;
                    project.startDate = startDate;
                    project.endDate = endDate;
                    project.status = status;
                    project.skills = skills;
                }
            } else {
                const newProject = {
                    id: Math.max(...projects.map(p => p.id)) + 1,
                    category: category,
                    title: title,
                    description: description,
                    image: icon,
                    capacity: { current: 0, max: capacity },
                    status: status,
                    leader: leader,
                    department: department,
                    startDate: startDate,
                    endDate: endDate,
                    skills: skills,
                    members: [],
                    progress: [],
                    comments: []
                };
                projects.push(newProject);
            }

            closeProjectForm();
            renderAdminProjects();
            updateAdminStats();

            document.getElementById('successTitle').textContent = '保存完了';
            document.getElementById('successMessage').textContent = 'プロジェクトを保存しました。';
            document.getElementById('successOverlay').style.display = 'flex';
        }

        // 上長選択の表示切り替え
        function toggleManagerSelect() {
            const role = document.getElementById('newUserRole').value;
            const managerGroup = document.getElementById('managerSelectGroup');
            // 上長・管理者の場合は上長選択を非表示
            managerGroup.style.display = (role === 'manager' || role === 'admin') ? 'none' : 'block';
        }

        // 上長選択リストを更新
        function populateManagerSelect(currentUserId = null) {
            const select = document.getElementById('newUserManagerId');
            const managers = users.filter(u => u.role === 'manager' && u.status === 'active' && u.id !== currentUserId);

            select.innerHTML = '<option value="">選択してください</option>' +
                managers.map(m => `<option value="${m.id}">${m.name}（${m.departmentName}）</option>`).join('');
        }

        // ユーザー作成フォームを開く
        function openUserForm() {
            document.getElementById('userFormTitle').textContent = '新規ユーザー登録';
            document.getElementById('userForm').reset();
            document.getElementById('editUserId').value = '';
            document.getElementById('newUserId').disabled = false;
            document.getElementById('newUserPassword').required = true;
            document.getElementById('newUserPassword').placeholder = 'パスワードを入力';

            populateManagerSelect();
            toggleManagerSelect();

            document.getElementById('userFormModal').classList.add('show');
        }

        // ユーザー編集
        function editUser(id) {
            const user = users.find(u => u.id === id);
            if (!user) return;

            document.getElementById('userFormTitle').textContent = 'ユーザー編集';
            document.getElementById('editUserId').value = user.id;
            document.getElementById('newUserId').value = user.id;
            document.getElementById('newUserId').disabled = false;
            document.getElementById('newUserName').value = user.name;
            document.getElementById('newUserPassword').value = '';
            document.getElementById('newUserPassword').required = false;
            document.getElementById('newUserPassword').placeholder = '変更する場合のみ入力';
            document.getElementById('newUserDepartment').value = user.department;
            document.getElementById('newUserEmail').value = user.email || '';
            document.getElementById('newUserRole').value = user.role;
            document.getElementById('newUserStatus').value = user.status;

            populateManagerSelect(user.id);
            document.getElementById('newUserManagerId').value = user.managerId || '';
            toggleManagerSelect();

            document.getElementById('userFormModal').classList.add('show');
        }

        // ユーザーフォームを閉じる
        function closeUserForm() {
            document.getElementById('userFormModal').classList.remove('show');
            document.getElementById('newUserPassword').placeholder = 'パスワードを入力';
        }

        // ユーザー保存
        function saveUser() {
            const editId = document.getElementById('editUserId').value;
            const userId = document.getElementById('newUserId').value;
            const name = document.getElementById('newUserName').value;
            const password = document.getElementById('newUserPassword').value;
            const department = document.getElementById('newUserDepartment').value;
            const email = document.getElementById('newUserEmail').value;
            const role = document.getElementById('newUserRole').value;
            const managerId = document.getElementById('newUserManagerId').value;
            const status = document.getElementById('newUserStatus').value;

            if (!userId || !name || !department) {
                alert('必須項目を入力してください');
                return;
            }

            if (editId) {
                // 編集
                const user = users.find(u => u.id === editId);
                if (user) {
                    // 社員IDが変更された場合、重複チェック
                    if (userId !== editId && users.find(u => u.id === userId)) {
                        alert('この社員IDは既に使用されています');
                        return;
                    }
                    user.id = userId;
                    user.name = name;
                    if (password) user.password = password;
                    user.department = department;
                    user.departmentName = departmentNames[department];
                    user.email = email;
                    user.role = role;
                    user.managerId = (role === 'manager' || role === 'admin') ? null : managerId;
                    user.status = status;
                }
            } else {
                // 新規作成
                if (!password) {
                    alert('パスワードを入力してください');
                    return;
                }
                if (users.find(u => u.id === userId)) {
                    alert('この社員IDは既に使用されています');
                    return;
                }
                const newUser = {
                    id: userId,
                    name: name,
                    password: password,
                    department: department,
                    departmentName: departmentNames[department],
                    email: email,
                    role: role,
                    managerId: (role === 'manager' || role === 'admin') ? null : managerId,
                    status: status
                };
                users.push(newUser);
            }

            closeUserForm();
            renderUsers();
            updateAdminStats();

            document.getElementById('successTitle').textContent = '保存完了';
            document.getElementById('successMessage').textContent = 'ユーザー情報を保存しました。';
            document.getElementById('successOverlay').style.display = 'flex';
        }

        // プロジェクト削除（確認）
        function deleteProject(id) {
            const project = projects.find(p => p.id === id);
            if (!project) return;

            deleteTargetId = id;
            deleteTargetType = 'project';
            document.getElementById('deleteConfirmMessage').textContent = `プロジェクト「${project.title}」を削除しますか？`;
            document.getElementById('deleteConfirmModal').classList.add('show');
        }

        // ユーザー削除（確認）
        function deleteUser(id) {
            const user = users.find(u => u.id === id);
            if (!user) return;

            deleteTargetId = id;
            deleteTargetType = 'user';
            document.getElementById('deleteConfirmMessage').textContent = `ユーザー「${user.name}（${user.id}）」を削除しますか？`;
            document.getElementById('deleteConfirmModal').classList.add('show');
        }

        // 削除確認を閉じる
        function closeDeleteConfirm() {
            document.getElementById('deleteConfirmModal').classList.remove('show');
            deleteTargetId = null;
            deleteTargetType = null;
        }

        // 削除実行
        function confirmDelete() {
            if (deleteTargetType === 'project' && deleteTargetId) {
                projects = projects.filter(p => p.id !== deleteTargetId);
                renderAdminProjects();
            } else if (deleteTargetType === 'user' && deleteTargetId) {
                users = users.filter(u => u.id !== deleteTargetId);
                renderUsers();
            }
            updateAdminStats();
            closeDeleteConfirm();

            document.getElementById('successTitle').textContent = '削除完了';
            document.getElementById('successMessage').textContent = '削除しました。';
            document.getElementById('successOverlay').style.display = 'flex';
        }

        // 申請承認
        function approveApplication(id) {
            const app = applications.find(a => a.id === id);
            if (app) {
                app.status = 'approved';

                const project = projects.find(p => p.id === app.projectId);
                if (project) {
                    project.capacity.current++;
                    project.members.push({ name: app.applicant, role: 'メンバー' });
                }
            }

            renderApplications();
            renderAdminProjects();
            updateAdminStats();

            document.getElementById('successTitle').textContent = '承認完了';
            document.getElementById('successMessage').textContent = '参加申請を承認しました。';
            document.getElementById('successOverlay').style.display = 'flex';
        }

        // 申請却下
        function rejectApplication(id) {
            const app = applications.find(a => a.id === id);
            if (app) {
                app.status = 'rejected';
            }

            renderApplications();
            updateAdminStats();

            document.getElementById('successTitle').textContent = '却下完了';
            document.getElementById('successMessage').textContent = '参加申請を却下しました。';
            document.getElementById('successOverlay').style.display = 'flex';
        }

        // ======= ワークフロー機能 =======

        // 一般ユーザー用プロジェクト企画フォームを開く
        function openUserProjectForm() {
            if (!currentUser) return;

            document.getElementById('userProjectForm').reset();
            document.getElementById('userProjectManager').value = currentUser.managerName || '（上長未設定）';

            // PJ承認者のドロップダウンを設定（マネージャー権限を持つユーザー）
            const approverSelect = document.getElementById('userProjectApprover');
            approverSelect.innerHTML = '<option value="">-- 選択してください --</option>';

            // マネージャー権限を持つユーザーを取得（自分と自分の上長以外）
            const managers = users.filter(u =>
                u.role === 'manager' &&
                u.id !== currentUser.id &&
                u.id !== currentUser.managerId &&
                u.status === 'active'
            ).sort((a, b) => a.departmentName.localeCompare(b.departmentName));

            managers.forEach(m => {
                const option = document.createElement('option');
                option.value = m.id;
                option.textContent = `${m.name}（${m.departmentName}）`;
                approverSelect.appendChild(option);
            });

            document.getElementById('userProjectFormModal').classList.add('show');

            // 画像設定を初期化
            switchImageOption('auto');
            removeUploadedImage();
            setTimeout(() => {
                updateImagePreview();
            }, 100);
        }

        // 一般ユーザー用プロジェクト企画フォームを閉じる
        function closeUserProjectForm() {
            document.getElementById('userProjectFormModal').classList.remove('show');
        }

        // ========== 画像生成・アップロード機能 ==========

        // 画像オプション切り替え
        function switchImageOption(option) {
            document.querySelectorAll('.image-option-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.image-option-content').forEach(content => content.classList.add('hidden'));

            if (option === 'auto') {
                document.querySelector('.image-option-tab:first-child').classList.add('active');
                document.getElementById('imageOptionAuto').classList.remove('hidden');
                updateImagePreview();
            } else {
                document.querySelector('.image-option-tab:last-child').classList.add('active');
                document.getElementById('imageOptionUpload').classList.remove('hidden');
            }
        }

        // 画像スタイル定義
        const imageStyles = {
            gradient1: { type: 'gradient', colors: ['#2d3a4a', '#4a7c9b'] },
            gradient2: { type: 'gradient', colors: ['#2e7d5a', '#4aa87a'] },
            gradient3: { type: 'gradient', colors: ['#4a3f6b', '#7c6b9b'] },
            gradient4: { type: 'gradient', colors: ['#b8860b', '#daa520'] },
            solid1: { type: 'solid', color: '#2d3a4a' },
            solid2: { type: 'solid', color: '#1e3a5f' },
            pattern1: { type: 'pattern', pattern: 'dots', baseColor: '#2d3a4a' },
            pattern2: { type: 'pattern', pattern: 'lines', baseColor: '#4a7c9b' }
        };

        // プレビュー画像を更新
        function updateImagePreview() {
            const canvas = document.getElementById('previewCanvas');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const width = 600;
            const height = 400;

            // 背景を描画
            const styleKey = document.getElementById('imageStyle')?.value || 'gradient1';
            const style = imageStyles[styleKey];

            if (style.type === 'gradient') {
                const gradient = ctx.createLinearGradient(0, 0, width, height);
                gradient.addColorStop(0, style.colors[0]);
                gradient.addColorStop(1, style.colors[1]);
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, width, height);
            } else if (style.type === 'solid') {
                ctx.fillStyle = style.color;
                ctx.fillRect(0, 0, width, height);
            } else if (style.type === 'pattern') {
                ctx.fillStyle = style.baseColor;
                ctx.fillRect(0, 0, width, height);

                if (style.pattern === 'dots') {
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.1)';
                    for (let x = 0; x < width; x += 30) {
                        for (let y = 0; y < height; y += 30) {
                            ctx.beginPath();
                            ctx.arc(x, y, 4, 0, Math.PI * 2);
                            ctx.fill();
                        }
                    }
                } else if (style.pattern === 'lines') {
                    ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
                    ctx.lineWidth = 2;
                    for (let i = -height; i < width + height; i += 40) {
                        ctx.beginPath();
                        ctx.moveTo(i, 0);
                        ctx.lineTo(i + height, height);
                        ctx.stroke();
                    }
                }
            }

            // 装飾的な要素を追加
            ctx.fillStyle = 'rgba(255, 255, 255, 0.05)';
            ctx.beginPath();
            ctx.arc(width * 0.8, height * 0.3, 150, 0, Math.PI * 2);
            ctx.fill();

            // アイコン（絵文字）を描画
            const icon = document.getElementById('userProjectIcon')?.value || '📋';
            const iconSizeMap = { small: 60, medium: 80, large: 100 };
            const iconSize = iconSizeMap[document.getElementById('iconSize')?.value || 'medium'];

            ctx.font = `${iconSize}px Arial`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(icon, width / 2, height / 2 - 40);

            // タイトルを描画
            const title = document.getElementById('userProjectTitle')?.value || 'プロジェクト名';
            ctx.fillStyle = 'white';
            ctx.font = 'bold 28px "Noto Sans JP", sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';

            // タイトルが長い場合は折り返し
            const maxWidth = width - 80;
            const words = title.split('');
            let line = '';
            let lines = [];

            for (let i = 0; i < words.length; i++) {
                const testLine = line + words[i];
                const metrics = ctx.measureText(testLine);
                if (metrics.width > maxWidth && line.length > 0) {
                    lines.push(line);
                    line = words[i];
                } else {
                    line = testLine;
                }
            }
            lines.push(line);

            // 最大2行まで
            lines = lines.slice(0, 2);
            const lineHeight = 36;
            const startY = height / 2 + 30;

            lines.forEach((line, index) => {
                ctx.fillText(line, width / 2, startY + (index * lineHeight));
            });

            // カテゴリラベルを追加
            const category = document.getElementById('userProjectCategory')?.value || 'company';
            const categoryLabels = { company: '全社', department: '部署', other: 'その他' };
            const categoryColors = { company: '#4a7c9b', department: '#2e7d5a', other: '#b8860b' };

            ctx.fillStyle = categoryColors[category];
            roundRect(ctx, 20, 20, 80, 32, 6);
            ctx.fill();

            ctx.fillStyle = 'white';
            ctx.font = 'bold 14px "Noto Sans JP", sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(categoryLabels[category], 60, 38);

            // サイズ表示を追加
            ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
            ctx.font = '12px Arial';
            ctx.textAlign = 'right';
            ctx.fillText('600 × 400 px', width - 15, height - 15);

            // hidden inputに画像データを保存
            const imageData = canvas.toDataURL('image/png');
            document.getElementById('projectImageData').value = imageData;
        }

        // 角丸四角形を描画するヘルパー関数
        function roundRect(ctx, x, y, width, height, radius) {
            ctx.beginPath();
            ctx.moveTo(x + radius, y);
            ctx.lineTo(x + width - radius, y);
            ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
            ctx.lineTo(x + width, y + height - radius);
            ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
            ctx.lineTo(x + radius, y + height);
            ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
            ctx.lineTo(x, y + radius);
            ctx.quadraticCurveTo(x, y, x + radius, y);
            ctx.closePath();
        }

        // 画像を再生成
        function regenerateImage() {
            updateImagePreview();
        }

        // 画像アップロード処理
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // ファイルサイズチェック（5MB以下）
            if (file.size > 5 * 1024 * 1024) {
                alert('ファイルサイズは5MB以下にしてください。');
                return;
            }

            // 画像形式チェック
            if (!file.type.startsWith('image/')) {
                alert('画像ファイルを選択してください。');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    // 600x400にリサイズ
                    const canvas = document.createElement('canvas');
                    canvas.width = 600;
                    canvas.height = 400;
                    const ctx = canvas.getContext('2d');

                    // アスペクト比を維持してセンタークロップ
                    const sourceRatio = img.width / img.height;
                    const targetRatio = 600 / 400;

                    let sx, sy, sWidth, sHeight;

                    if (sourceRatio > targetRatio) {
                        // 横長の画像
                        sHeight = img.height;
                        sWidth = img.height * targetRatio;
                        sx = (img.width - sWidth) / 2;
                        sy = 0;
                    } else {
                        // 縦長の画像
                        sWidth = img.width;
                        sHeight = img.width / targetRatio;
                        sx = 0;
                        sy = (img.height - sHeight) / 2;
                    }

                    ctx.drawImage(img, sx, sy, sWidth, sHeight, 0, 0, 600, 400);

                    // プレビューを表示
                    const imageData = canvas.toDataURL('image/png');
                    document.getElementById('uploadedImage').src = imageData;
                    document.getElementById('uploadArea').classList.add('hidden');
                    document.getElementById('uploadedPreview').classList.remove('hidden');
                    document.getElementById('projectImageData').value = imageData;

                    // 元画像サイズを表示
                    const sizeInfo = `元画像: ${img.width} × ${img.height} px → リサイズ: 600 × 400 px`;
                    console.log(sizeInfo);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // アップロード画像を削除
        function removeUploadedImage() {
            document.getElementById('uploadArea').classList.remove('hidden');
            document.getElementById('uploadedPreview').classList.add('hidden');
            document.getElementById('uploadedImage').src = '';
            document.getElementById('imageUpload').value = '';
            document.getElementById('projectImageData').value = '';
        }

        // ドラッグ＆ドロップ対応
        document.addEventListener('DOMContentLoaded', function() {
            const uploadArea = document.getElementById('uploadArea');
            if (uploadArea) {
                uploadArea.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    uploadArea.classList.add('dragover');
                });

                uploadArea.addEventListener('dragleave', function(e) {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                });

                uploadArea.addEventListener('drop', function(e) {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        document.getElementById('imageUpload').files = files;
                        handleImageUpload({ target: { files: files } });
                    }
                });
            }
        });

        // ========== 画像生成機能ここまで ==========

        // プロジェクト企画を申請
        function submitProjectProposal() {
            if (!currentUser) return;

            const title = document.getElementById('userProjectTitle').value;
            const category = document.getElementById('userProjectCategory').value;
            const description = document.getElementById('userProjectDescription').value;
            const icon = document.getElementById('userProjectIcon').value || '📋';
            const capacity = parseInt(document.getElementById('userProjectCapacity').value);
            const startDate = document.getElementById('userProjectStartDate').value;
            const endDate = document.getElementById('userProjectEndDate').value;
            const skills = document.getElementById('userProjectSkills').value.split(',').map(s => s.trim()).filter(s => s);

            // PJ承認者を取得
            const approverId = document.getElementById('userProjectApprover').value;

            if (!title || !description || !capacity) {
                alert('必須項目を入力してください');
                return;
            }

            if (!currentUser.managerId) {
                alert('上長が設定されていないため、申請できません。管理者にお問い合わせください。');
                return;
            }

            if (!approverId) {
                alert('プロジェクト承認者を選択してください');
                return;
            }

            // 承認者の情報を取得
            const approver = users.find(u => u.id === approverId);
            if (!approver) {
                alert('承認者が見つかりません');
                return;
            }

            const now = new Date();
            const dateStr = now.toLocaleDateString('ja-JP');
            const timeStr = now.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });

            // 画像データを取得
            const imageData = document.getElementById('projectImageData').value;

            const newProposal = {
                id: projectProposals.length > 0 ? Math.max(...projectProposals.map(p => p.id)) + 1 : 1,
                title: title,
                category: category,
                description: description,
                icon: icon,
                image: imageData,
                capacity: capacity,
                leader: currentUser.name,
                department: currentUser.departmentName,
                startDate: startDate,
                endDate: endDate,
                skills: skills,
                submittedBy: currentUser.id,
                submitterName: currentUser.name,
                submitterEmail: currentUser.email,
                // 新しいワークフロー: pending_manager → pending_approver → pending_admin → approved
                workflowStatus: 'pending_manager',
                workflowHistory: [
                    { action: 'submit', by: currentUser.name, date: `${dateStr} ${timeStr}`, comment: 'プロジェクト企画を申請しました' }
                ],
                // 上長情報
                managerId: currentUser.managerId,
                managerName: currentUser.managerName,
                managerEmail: currentUser.managerEmail,
                // PJ承認者情報
                approverId: approver.id,
                approverName: approver.name,
                approverEmail: approver.email,
                approverDepartment: approver.departmentName,
                createdAt: dateStr
            };

            projectProposals.push(newProposal);

            // メール通知を送信
            sendWorkflowNotification('submit', newProposal);

            closeUserProjectForm();
            renderMyProposals();

            document.getElementById('successTitle').textContent = '申請完了';
            document.getElementById('successMessage').innerHTML = `プロジェクト企画「${title}」を申請しました。<br>上長の承認をお待ちください。`;
            document.getElementById('successOverlay').style.display = 'flex';

            // 通知を追加
            notifications.unshift({
                id: notifications.length + 1,
                icon: '📝',
                title: 'プロジェクト企画を申請しました',
                detail: `${title} • ${dateStr}`
            });
            renderNotifications();
        }

        // 自分のプロジェクト企画一覧を表示
        function renderMyProposals() {
            const container = document.getElementById('myProposalsList');
            if (!container || !currentUser) return;

            const myProposals = projectProposals.filter(p => p.submittedBy === currentUser.id);

            if (myProposals.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary);">申請中のプロジェクト企画はありません</p>';
                return;
            }

            container.innerHTML = myProposals.map(p => {
                let statusLabel = '';
                let statusClass = '';
                switch(p.workflowStatus) {
                    case 'pending_manager':
                        statusLabel = '上長承認待ち';
                        statusClass = 'workflow-pending-manager';
                        break;
                    case 'pending_admin':
                        statusLabel = '管理者承認待ち';
                        statusClass = 'workflow-pending-admin';
                        break;
                    case 'approved':
                        statusLabel = '承認済み';
                        statusClass = 'workflow-approved';
                        break;
                    case 'rejected':
                        statusLabel = '却下';
                        statusClass = 'workflow-rejected';
                        break;
                }

                return `
                    <div class="my-project-item" onclick="openWorkflowDetail(${p.id}, 'user')">
                        <div class="my-project-icon">${p.icon}</div>
                        <div class="my-project-info">
                            <div class="my-project-title">${p.title}</div>
                            <div class="my-project-role">
                                <span class="application-status ${statusClass}" style="margin-right: 8px;">${statusLabel}</span>
                                申請日: ${p.createdAt}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // 上長用：承認待ち企画一覧を表示
        function renderManagerApprovals() {
            if (!currentUser || currentUser.role !== 'manager') return;

            // 上長メニューを表示
            document.getElementById('managerNavItem').style.display = 'flex';

            const container = document.getElementById('managerApprovalList');
            if (!container) return;

            const pendingProposals = projectProposals.filter(p =>
                p.managerId === currentUser.id && p.workflowStatus === 'pending_manager'
            );

            if (pendingProposals.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">承認待ちの企画はありません</p>';
                return;
            }

            container.innerHTML = pendingProposals.map(p => {
                let categoryLabel = '';
                if (p.category === 'company') categoryLabel = '全社';
                else if (p.category === 'department') categoryLabel = '部署';
                else categoryLabel = 'その他';

                return `
                    <div class="my-project-item" style="cursor: pointer;">
                        <div class="my-project-icon">${p.icon}</div>
                        <div class="my-project-info" style="flex: 1;">
                            <div class="my-project-title">${p.title}</div>
                            <div class="my-project-role">
                                申請者: ${p.submitterName} • ${categoryLabel} • ${p.createdAt}
                            </div>
                        </div>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-outline" onclick="openWorkflowDetail(${p.id}, 'manager'); event.stopPropagation();">詳細</button>
                            <button class="btn btn-sm btn-success" onclick="managerApprove(${p.id}); event.stopPropagation();">承認</button>
                            <button class="btn btn-sm btn-danger" onclick="managerReject(${p.id}); event.stopPropagation();">却下</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // 上長承認 → PJ承認者へ
        function managerApprove(proposalId) {
            const proposal = projectProposals.find(p => p.id === proposalId);
            if (!proposal || !currentUser) return;

            const now = new Date();
            const dateStr = now.toLocaleDateString('ja-JP');
            const timeStr = now.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });

            // 上長承認後はPJ承認者へ
            proposal.workflowStatus = 'pending_approver';
            proposal.workflowHistory.push({
                action: 'manager_approve',
                by: currentUser.name,
                date: `${dateStr} ${timeStr}`,
                comment: `上長が承認しました。PJ承認者（${proposal.approverName}）の承認を待っています。`
            });

            // メール通知
            sendWorkflowNotification('manager_approve', proposal);

            renderManagerApprovals();

            document.getElementById('successTitle').textContent = '承認完了';
            document.getElementById('successMessage').innerHTML = `「${proposal.title}」を承認しました。<br>PJ承認者（${proposal.approverName}）の承認に進みます。`;
            document.getElementById('successOverlay').style.display = 'flex';
        }

        // PJ承認者承認 → システム管理者へ
        function approverApprove(proposalId) {
            const proposal = projectProposals.find(p => p.id === proposalId);
            if (!proposal || !currentUser) return;

            const now = new Date();
            const dateStr = now.toLocaleDateString('ja-JP');
            const timeStr = now.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });

            proposal.workflowStatus = 'pending_admin';
            proposal.workflowHistory.push({
                action: 'approver_approve',
                by: currentUser.name,
                date: `${dateStr} ${timeStr}`,
                comment: 'PJ承認者が承認しました。システム管理者の最終承認を待っています。'
            });

            // メール通知
            sendWorkflowNotification('approver_approve', proposal);

            renderApproverApprovals();

            document.getElementById('successTitle').textContent = '承認完了';
            document.getElementById('successMessage').innerHTML = `「${proposal.title}」を承認しました。<br>システム管理者の最終承認に進みます。`;
            document.getElementById('successOverlay').style.display = 'flex';
        }

        // PJ承認者却下
        function approverReject(proposalId) {
            const comment = prompt('却下理由を入力してください（任意）:');

            const proposal = projectProposals.find(p => p.id === proposalId);
            if (!proposal || !currentUser) return;

            const now = new Date();
            const dateStr = now.toLocaleDateString('ja-JP');
            const timeStr = now.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });

            proposal.workflowStatus = 'rejected';
            proposal.workflowHistory.push({
                action: 'approver_reject',
                by: currentUser.name,
                date: `${dateStr} ${timeStr}`,
                comment: comment || 'PJ承認者により却下されました'
            });

            // メール通知
            sendWorkflowNotification('approver_reject', proposal, comment);

            renderApproverApprovals();

            document.getElementById('successTitle').textContent = '却下完了';
            document.getElementById('successMessage').textContent = `「${proposal.title}」を却下しました。`;
            document.getElementById('successOverlay').style.display = 'flex';
        }

        // PJ承認者用：承認待ち一覧を表示
        function renderApproverApprovals() {
            const container = document.getElementById('approverApprovalsList');
            if (!container || !currentUser) return;

            // 自分がPJ承認者として指定されている承認待ちの企画を表示
            const pendingApprovals = projectProposals.filter(p =>
                p.approverId === currentUser.id &&
                p.workflowStatus === 'pending_approver'
            );

            if (pendingApprovals.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary);">承認待ちのプロジェクト企画はありません</p>';
                return;
            }

            container.innerHTML = pendingApprovals.map(p => `
                <div class="approval-card">
                    <div class="approval-header">
                        <span class="approval-icon">${p.icon || '📋'}</span>
                        <div>
                            <div class="approval-title">${p.title}</div>
                            <div class="approval-meta">申請者: ${p.submitterName} • ${p.createdAt}</div>
                            <div class="approval-meta">カテゴリ: ${p.category === 'company' ? '全社' : p.category === 'department' ? '部署' : 'その他'}</div>
                        </div>
                    </div>
                    <div class="approval-description">${p.description}</div>
                    <div class="approval-workflow">
                        <span class="workflow-badge workflow-pending-approver">PJ承認者承認待ち</span>
                    </div>
                    <div class="approval-actions">
                        <button class="btn btn-sm btn-success" onclick="approverApprove(${p.id})">✓ 承認</button>
                        <button class="btn btn-sm btn-danger" onclick="approverReject(${p.id})">✕ 却下</button>
                        <button class="btn btn-sm btn-outline" onclick="showWorkflowDetail(${p.id})">詳細</button>
                    </div>
                </div>
            `).join('');
        }

        // 上長却下
        function managerReject(proposalId) {
            const comment = prompt('却下理由を入力してください（任意）:');

            const proposal = projectProposals.find(p => p.id === proposalId);
            if (!proposal || !currentUser) return;

            const now = new Date();
            const dateStr = now.toLocaleDateString('ja-JP');
            const timeStr = now.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });

            proposal.workflowStatus = 'rejected';
            proposal.workflowHistory.push({
                action: 'manager_reject',
                by: currentUser.name,
                date: `${dateStr} ${timeStr}`,
                comment: comment || '上長により却下されました'
            });

            // メール通知
            sendWorkflowNotification('manager_reject', proposal, comment);

            renderManagerApprovals();

            document.getElementById('successTitle').textContent = '却下完了';
            document.getElementById('successMessage').textContent = `「${proposal.title}」を却下しました。`;
            document.getElementById('successOverlay').style.display = 'flex';
        }

        // 管理者用：ワークフロー一覧を表示
        function renderAdminWorkflow() {
            const container = document.getElementById('adminWorkflowList');
            if (!container) return;

            const proposals = projectProposals.filter(p =>
                p.workflowStatus === 'pending_admin' || p.workflowStatus === 'approved' || p.workflowStatus === 'rejected'
            );

            if (proposals.length === 0) {
                container.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--text-secondary);">承認待ちの企画はありません</td></tr>';
                return;
            }

            container.innerHTML = proposals.map(p => {
                let categoryLabel = '';
                if (p.category === 'company') categoryLabel = '全社';
                else if (p.category === 'department') categoryLabel = '部署';
                else categoryLabel = 'その他';

                let statusLabel = '';
                let statusClass = '';
                switch(p.workflowStatus) {
                    case 'pending_admin':
                        statusLabel = '最終承認待ち';
                        statusClass = 'workflow-pending-admin';
                        break;
                    case 'approved':
                        statusLabel = '承認済み';
                        statusClass = 'workflow-approved';
                        break;
                    case 'rejected':
                        statusLabel = '却下';
                        statusClass = 'workflow-rejected';
                        break;
                }

                const managerApproval = p.workflowHistory.find(h => h.action === 'manager_approve');
                const managerApproveDate = managerApproval ? managerApproval.date.split(' ')[0] : '-';

                const actionButtons = p.workflowStatus === 'pending_admin' ? `
                    <div class="action-buttons">
                        <button class="btn btn-sm btn-outline" onclick="openWorkflowDetail(${p.id}, 'admin')">詳細</button>
                        <button class="btn btn-sm btn-success" onclick="adminApproveProposal(${p.id})">承認</button>
                        <button class="btn btn-sm btn-danger" onclick="adminRejectProposal(${p.id})">却下</button>
                    </div>
                ` : `<button class="btn btn-sm btn-outline" onclick="openWorkflowDetail(${p.id}, 'admin')">詳細</button>`;

                return `
                    <tr>
                        <td><strong>${p.icon} ${p.title}</strong></td>
                        <td>${p.submitterName}</td>
                        <td>${categoryLabel}</td>
                        <td>${managerApproveDate}<br><small style="color: var(--text-secondary);">${p.managerName}</small></td>
                        <td><span class="application-status ${statusClass}">${statusLabel}</span></td>
                        <td>${actionButtons}</td>
                    </tr>
                `;
            }).join('');
        }

        // 管理者最終承認
        function adminApproveProposal(proposalId) {
            const proposal = projectProposals.find(p => p.id === proposalId);
            if (!proposal) return;

            const now = new Date();
            const dateStr = now.toLocaleDateString('ja-JP');
            const timeStr = now.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });

            proposal.workflowStatus = 'approved';
            proposal.workflowHistory.push({
                action: 'admin_approve',
                by: '管理者',
                date: `${dateStr} ${timeStr}`,
                comment: '管理者が最終承認しました。プロジェクトが公開されました。'
            });

            // プロジェクトとして正式に追加
            const newProject = {
                id: Math.max(...projects.map(p => p.id)) + 1,
                category: proposal.category,
                title: proposal.title,
                description: proposal.description,
                image: proposal.icon,
                capacity: { current: 1, max: proposal.capacity },
                status: 'recruiting',
                leader: proposal.leader,
                department: proposal.department,
                startDate: proposal.startDate || dateStr,
                endDate: proposal.endDate || '-',
                skills: proposal.skills,
                members: [{ name: proposal.leader, role: 'リーダー' }],
                progress: [],
                comments: []
            };
            projects.push(newProject);

            // メール通知
            sendWorkflowNotification('admin_approve', proposal);

            renderAdminWorkflow();
            renderAdminProjects();
            updateAdminStats();

            document.getElementById('successTitle').textContent = '最終承認完了';
            document.getElementById('successMessage').innerHTML = `「${proposal.title}」を承認しました。<br>プロジェクトが公開されました。`;
            document.getElementById('successOverlay').style.display = 'flex';
        }

        // 管理者却下
        function adminRejectProposal(proposalId) {
            const comment = prompt('却下理由を入力してください（任意）:');

            const proposal = projectProposals.find(p => p.id === proposalId);
            if (!proposal) return;

            const now = new Date();
            const dateStr = now.toLocaleDateString('ja-JP');
            const timeStr = now.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });

            proposal.workflowStatus = 'rejected';
            proposal.workflowHistory.push({
                action: 'admin_reject',
                by: '管理者',
                date: `${dateStr} ${timeStr}`,
                comment: comment || '管理者により却下されました'
            });

            // メール通知
            sendWorkflowNotification('admin_reject', proposal, comment);

            renderAdminWorkflow();
            updateAdminStats();

            document.getElementById('successTitle').textContent = '却下完了';
            document.getElementById('successMessage').textContent = `「${proposal.title}」を却下しました。`;
            document.getElementById('successOverlay').style.display = 'flex';
        }

        // ワークフロー詳細モーダルを開く
        let selectedProposal = null;
        function openWorkflowDetail(proposalId, viewerType) {
            selectedProposal = projectProposals.find(p => p.id === proposalId);
            if (!selectedProposal) return;

            document.getElementById('workflowDetailTitle').textContent = selectedProposal.title;

            let categoryLabel = '';
            if (selectedProposal.category === 'company') categoryLabel = '全社プロジェクト';
            else if (selectedProposal.category === 'department') categoryLabel = '部署プロジェクト';
            else categoryLabel = 'その他（社員活動）';

            let statusLabel = '';
            let statusClass = '';
            switch(selectedProposal.workflowStatus) {
                case 'pending_manager':
                    statusLabel = '上長承認待ち';
                    statusClass = 'workflow-pending-manager';
                    break;
                case 'pending_admin':
                    statusLabel = '管理者承認待ち';
                    statusClass = 'workflow-pending-admin';
                    break;
                case 'approved':
                    statusLabel = '承認済み';
                    statusClass = 'workflow-approved';
                    break;
                case 'rejected':
                    statusLabel = '却下';
                    statusClass = 'workflow-rejected';
                    break;
            }

            document.getElementById('workflowDetailBody').innerHTML = `
                <div class="detail-image" style="height: 120px; font-size: 48px;">${selectedProposal.icon}</div>

                <div style="margin-bottom: 16px;">
                    <span class="application-status ${statusClass}" style="font-size: 14px; padding: 6px 12px;">${statusLabel}</span>
                </div>

                <div class="detail-section">
                    <h3>概要</h3>
                    <p>${selectedProposal.description}</p>
                </div>

                <div class="detail-section">
                    <h3>基本情報</h3>
                    <div class="progress-section">
                        <div class="progress-item">
                            <span>申請者</span>
                            <strong>${selectedProposal.submitterName}</strong>
                        </div>
                        <div class="progress-item">
                            <span>カテゴリ</span>
                            <strong>${categoryLabel}</strong>
                        </div>
                        <div class="progress-item">
                            <span>担当部署</span>
                            <strong>${selectedProposal.department}</strong>
                        </div>
                        <div class="progress-item">
                            <span>希望定員</span>
                            <strong>${selectedProposal.capacity}人</strong>
                        </div>
                        <div class="progress-item">
                            <span>期間</span>
                            <strong>${selectedProposal.startDate || '未定'} 〜 ${selectedProposal.endDate || '未定'}</strong>
                        </div>
                        <div class="progress-item">
                            <span>承認者（上長）</span>
                            <strong>${selectedProposal.managerName}</strong>
                        </div>
                    </div>
                </div>

                ${selectedProposal.skills.length > 0 ? `
                <div class="detail-section">
                    <h3>求めるスキル</h3>
                    <div class="member-list">
                        ${selectedProposal.skills.map(skill => `<span class="member-badge">${skill}</span>`).join('')}
                    </div>
                </div>
                ` : ''}

                <div class="detail-section">
                    <h3>ワークフロー履歴</h3>
                    <div class="workflow-history">
                        ${selectedProposal.workflowHistory.map(h => {
                            let iconClass = 'pending';
                            let icon = '⏳';
                            if (h.action.includes('approve')) {
                                iconClass = 'approved';
                                icon = '✅';
                            } else if (h.action.includes('reject')) {
                                iconClass = 'rejected';
                                icon = '❌';
                            } else if (h.action === 'submit') {
                                icon = '📝';
                            }
                            return `
                                <div class="workflow-history-item">
                                    <div class="workflow-history-icon ${iconClass}">${icon}</div>
                                    <div class="workflow-history-content">
                                        <div class="workflow-history-title">${h.comment}</div>
                                        <div class="workflow-history-detail">${h.by} • ${h.date}</div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;

            // フッターボタン
            let footerHtml = '<button class="btn btn-outline" onclick="closeWorkflowDetail()">閉じる</button>';

            if (viewerType === 'manager' && selectedProposal.workflowStatus === 'pending_manager') {
                footerHtml += `
                    <button class="btn btn-danger" onclick="managerReject(${selectedProposal.id}); closeWorkflowDetail();">却下</button>
                    <button class="btn btn-success" onclick="managerApprove(${selectedProposal.id}); closeWorkflowDetail();">承認</button>
                `;
            } else if (viewerType === 'admin' && selectedProposal.workflowStatus === 'pending_admin') {
                footerHtml += `
                    <button class="btn btn-danger" onclick="adminRejectProposal(${selectedProposal.id}); closeWorkflowDetail();">却下</button>
                    <button class="btn btn-success" onclick="adminApproveProposal(${selectedProposal.id}); closeWorkflowDetail();">承認</button>
                `;
            }

            document.getElementById('workflowDetailFooter').innerHTML = footerHtml;
            document.getElementById('workflowDetailModal').classList.add('show');
        }

        // ワークフロー詳細を閉じる
        function closeWorkflowDetail() {
            document.getElementById('workflowDetailModal').classList.remove('show');
            selectedProposal = null;
        }

        // メール通知を送信
        function sendWorkflowNotification(action, proposal, comment = '') {
            let to = '';
            let subject = '';
            let body = '';

            const baseUrl = window.location.href;

            switch(action) {
                case 'submit':
                    // 上長に通知
                    to = proposal.managerEmail;
                    subject = `【承認依頼】プロジェクト企画「${proposal.title}」`;
                    body = `${proposal.managerName} 様\n\n` +
                           `${proposal.submitterName}さんから、以下のプロジェクト企画の承認依頼が届きました。\n\n` +
                           `■ プロジェクト名: ${proposal.title}\n` +
                           `■ 申請者: ${proposal.submitterName}\n` +
                           `■ 概要: ${proposal.description}\n\n` +
                           `下記URLからシステムにログインして承認処理をお願いします。\n` +
                           `${baseUrl}\n\n` +
                           `--\nProject Portal - ベステラ プロジェクト管理`;
                    break;

                case 'manager_approve':
                    // 申請者と管理者に通知
                    to = `admin@besterra.co.jp,${proposal.submitterEmail}`;
                    subject = `【上長承認済】プロジェクト企画「${proposal.title}」`;
                    body = `プロジェクト企画「${proposal.title}」が上長（${proposal.managerName}）により承認されました。\n\n` +
                           `管理者の最終承認をお待ちください。\n\n` +
                           `■ プロジェクト名: ${proposal.title}\n` +
                           `■ 申請者: ${proposal.submitterName}\n` +
                           `■ 上長承認: ${proposal.managerName}\n\n` +
                           `--\nProject Portal - ベステラ プロジェクト管理`;
                    break;

                case 'manager_reject':
                    // 申請者に通知
                    to = proposal.submitterEmail;
                    subject = `【却下】プロジェクト企画「${proposal.title}」`;
                    body = `${proposal.submitterName} 様\n\n` +
                           `残念ながら、プロジェクト企画「${proposal.title}」は上長により却下されました。\n\n` +
                           `■ 却下理由: ${comment || '理由の記載なし'}\n\n` +
                           `内容を見直して再申請することができます。\n\n` +
                           `--\nProject Portal - ベステラ プロジェクト管理`;
                    break;

                case 'admin_approve':
                    // 申請者と上長に通知
                    to = `${proposal.submitterEmail},${proposal.managerEmail}`;
                    subject = `【承認完了】プロジェクト「${proposal.title}」が公開されました`;
                    body = `おめでとうございます！\n\n` +
                           `プロジェクト企画「${proposal.title}」が正式に承認され、公開されました。\n\n` +
                           `■ プロジェクト名: ${proposal.title}\n` +
                           `■ リーダー: ${proposal.leader}\n` +
                           `■ 定員: ${proposal.capacity}名\n\n` +
                           `Project Portalでメンバー募集を開始できます。\n` +
                           `${baseUrl}\n\n` +
                           `--\nProject Portal - ベステラ プロジェクト管理`;
                    break;

                case 'admin_reject':
                    // 申請者と上長に通知
                    to = `${proposal.submitterEmail},${proposal.managerEmail}`;
                    subject = `【却下】プロジェクト企画「${proposal.title}」`;
                    body = `プロジェクト企画「${proposal.title}」は管理者により却下されました。\n\n` +
                           `■ 却下理由: ${comment || '理由の記載なし'}\n\n` +
                           `内容を見直して再申請することができます。\n\n` +
                           `--\nProject Portal - ベステラ プロジェクト管理`;
                    break;
            }

            if (to && subject && body) {
                // メールクライアントを開く
                const mailtoLink = `mailto:${to}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                window.open(mailtoLink, '_blank');

                console.log('メール通知:', { to, subject, body });
            }
        }

        // ページ切り替え（上長ページ対応）
        const originalShowPage = showPage;
        showPage = function(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

            if (page === 'home') {
                document.getElementById('homePage').classList.add('active');
                document.querySelectorAll('.nav-item')[0].classList.add('active');
            } else if (page === 'my') {
                document.getElementById('myPage').classList.add('active');
                document.querySelectorAll('.nav-item')[1].classList.add('active');
                renderMyPage();
                renderMyProposals();
            } else if (page === 'manager') {
                document.getElementById('managerPage').classList.add('active');
                document.getElementById('managerNavItem').classList.add('active');
                renderManagerApprovals();
            } else if (page === 'notification') {
                document.getElementById('notificationPage').classList.add('active');
                const navItems = document.querySelectorAll('.nav-item');
                navItems[navItems.length - 1].classList.add('active');
            }
        };

        // 管理者パネル切り替え（ワークフロー対応）
        const originalSwitchAdminPanel = switchAdminPanel;
        switchAdminPanel = function(panel) {
            currentAdminPanel = panel;
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.admin-panel').forEach(p => p.classList.remove('active'));

            let tabIndex = 0;
            switch(panel) {
                case 'projects': tabIndex = 0; break;
                case 'workflow': tabIndex = 1; break;
                case 'applications': tabIndex = 2; break;
                case 'users': tabIndex = 3; break;
            }

            document.querySelectorAll('.admin-tab')[tabIndex].classList.add('active');
            document.getElementById(`${panel}Panel`).classList.add('active');

            if (panel === 'workflow') {
                renderAdminWorkflow();
            }
        };

        // 管理者ログイン時にワークフローも読み込む
        const originalAdminLogin = document.getElementById('adminLoginForm').onsubmit;
        document.getElementById('adminLoginForm').addEventListener('submit', function(e) {
            setTimeout(() => {
                if (isAdmin) {
                    renderAdminWorkflow();
                }
            }, 100);
        });

        // ユーザー登録フォームに上長選択を追加（権限が「上長」の場合用）

        // ================================================
        // Supabase データ連携関数
        // ================================================

        // Supabaseからユーザーデータを読み込む
        async function loadUsersFromSupabase() {
            try {
                const { data, error } = await supabaseClient
                    .from('users')
                    .select('*');
                if (error) throw error;
                // カラム名をキャメルケースに変換
                users = data.map(u => ({
                    id: u.id,
                    name: u.name,
                    password: u.password,
                    department: u.department,
                    departmentName: u.department_name,
                    role: u.role,
                    status: u.status,
                    email: u.email,
                    managerId: u.manager_id
                }));
                console.log('Users loaded from Supabase:', users.length);
            } catch (err) {
                console.error('Failed to load users from Supabase:', err);
            }
        }

        // Supabaseからプロジェクトデータを読み込む
        async function loadProjectsFromSupabase() {
            try {
                const { data, error } = await supabaseClient
                    .from('projects')
                    .select('*');
                if (error) throw error;

                // メンバー、進捗、コメントも読み込む
                const { data: members } = await supabaseClient.from('project_members').select('*');
                const { data: progress } = await supabaseClient.from('project_progress').select('*');
                const { data: comments } = await supabaseClient.from('project_comments').select('*');

                projects = data.map(p => ({
                    id: p.id,
                    category: p.category,
                    title: p.title,
                    description: p.description,
                    image: p.image,
                    capacity: { current: p.capacity_current, max: p.capacity_max },
                    status: p.status,
                    leader: p.leader,
                    department: p.department,
                    startDate: p.start_date,
                    endDate: p.end_date,
                    skills: p.skills || [],
                    members: (members || []).filter(m => m.project_id === p.id).map(m => ({
                        name: m.user_name,
                        role: m.role
                    })),
                    progress: (progress || []).filter(pr => pr.project_id === p.id).map(pr => ({
                        task: pr.task,
                        status: pr.status
                    })),
                    comments: (comments || []).filter(c => c.project_id === p.id).map(c => ({
                        author: c.author,
                        text: c.text,
                        date: c.comment_date
                    }))
                }));
                console.log('Projects loaded from Supabase:', projects.length);
            } catch (err) {
                console.error('Failed to load projects from Supabase:', err);
            }
        }

        // Supabaseから参加申請データを読み込む
        async function loadApplicationsFromSupabase() {
            try {
                const { data, error } = await supabaseClient
                    .from('applications')
                    .select('*');
                if (error) throw error;
                applications = data.map(a => ({
                    id: a.id,
                    applicant: a.applicant,
                    applicantId: a.applicant_id,
                    projectId: a.project_id,
                    projectTitle: a.project_title,
                    date: a.application_date,
                    status: a.status
                }));
                console.log('Applications loaded from Supabase:', applications.length);
            } catch (err) {
                console.error('Failed to load applications from Supabase:', err);
            }
        }

        // Supabaseから通知データを読み込む
        async function loadNotificationsFromSupabase() {
            try {
                const { data, error } = await supabaseClient
                    .from('notifications')
                    .select('*');
                if (error) throw error;
                notifications = data.map(n => ({
                    id: n.id,
                    icon: n.icon,
                    title: n.title,
                    detail: n.detail
                }));
                console.log('Notifications loaded from Supabase:', notifications.length);
            } catch (err) {
                console.error('Failed to load notifications from Supabase:', err);
            }
        }

        // すべてのデータを読み込む
        async function loadAllDataFromSupabase() {
            if (!useDatabase) return;
            console.log('Loading data from Supabase...');
            await Promise.all([
                loadUsersFromSupabase(),
                loadProjectsFromSupabase(),
                loadApplicationsFromSupabase(),
                loadNotificationsFromSupabase()
            ]);
            console.log('All data loaded from Supabase');
        }

        // 参加申請をSupabaseに保存
        async function saveApplicationToSupabase(application) {
            if (!useDatabase) return;
            try {
                const { data, error } = await supabaseClient
                    .from('applications')
                    .insert({
                        applicant: application.applicant,
                        applicant_id: application.applicantId,
                        project_id: application.projectId,
                        project_title: application.projectTitle,
                        status: application.status
                    })
                    .select()
                    .single();
                if (error) throw error;
                return data;
            } catch (err) {
                console.error('Failed to save application:', err);
            }
        }

        // コメントをSupabaseに保存
        async function saveCommentToSupabase(projectId, comment) {
            if (!useDatabase) return;
            try {
                const { data, error } = await supabaseClient
                    .from('project_comments')
                    .insert({
                        project_id: projectId,
                        author: comment.author,
                        text: comment.text,
                        comment_date: comment.date
                    })
                    .select()
                    .single();
                if (error) throw error;
                return data;
            } catch (err) {
                console.error('Failed to save comment:', err);
            }
        }

        // 初期化時にSupabaseからデータを読み込む
        (async function initApp() {
            await loadAllDataFromSupabase();
            // データ読み込み後にUIを更新
            renderProjects();
        })();
    </script>
</body>
</html>
